<!DOCTYPE html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ç©åˆ†(II) - 10.1 åƒæ•¸æ–¹ç¨‹æ›²ç·š</title>
    <script type="text/javascript">
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #fff7f9; /* Soft Pink */
            color: #5c524f; /* Muted Brown */
        }
        .font-zh { font-family: 'Noto Sans TC', sans-serif; }
        .font-en { font-family: 'Poppins', sans-serif; }
        .math-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0.25rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .math-display::-webkit-scrollbar { display: none; }
        .active-tab {
            background-color: #d8b4fe; /* Lavender */
            color: #4c1d95; /* Deep Purple */
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .inactive-tab {
            background-color: #f3e8ff; /* Light Lavender */
            color: #6b21a8; /* Purple */
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-content.show { max-height: 2000px; }
        .rotate-180 { transform: rotate(180deg); }
        .text-justify { text-align: justify; }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            pointer-events: auto;
        }
        .modal-overlay.show .modal-container { transform: translate(-50%, -50%) scale(1); }
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1.5rem;
            background-color: #5c524f;
            animation: blink 1s step-end infinite;
            margin-left: 2px;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #5c524f; }
        }
    </style>
</head>
<body class="text-lg font-zh">

    <header class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-purple-700 font-zh" data-i18n="header.title">
                        å¾®ç©åˆ†(II)é‡è£œä¿®ç­
                    </h1>
                    <p class="text-base text-stone-500 font-en" data-i18n="header.subtitle">æˆèª²è€å¸«:å³æ–‡éŠ“ (Prof. Wu Wen-Chuan)</p>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="#concepts" class="text-stone-600 hover:bg-purple-200 hover:text-purple-800 px-3 py-2 rounded-md text-base font-medium" data-i18n="nav.concepts">æ ¸å¿ƒæ¦‚å¿µ</a>
                    <a href="#examples" class="text-stone-600 hover:bg-purple-200 hover:text-purple-800 px-3 py-2 rounded-md text-base font-medium" data-i18n="nav.examples">ç¯„ä¾‹èªªæ˜</a>
                    <a href="#practice" class="text-stone-600 hover:bg-purple-200 hover:text-purple-800 px-3 py-2 rounded-md text-base font-medium" data-i18n="nav.practice">è‡ªæˆ‘ç·´ç¿’</a>
                    <button id="api-key-modal-trigger" class="text-stone-500 hover:text-purple-600 transition-colors duration-200" title="Set AI API Key">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"></path><circle cx="16.5" cy="7.5" r=".5"></circle></svg>
                    </button>
                    <button id="lang-toggle" class="bg-purple-100 text-purple-700 font-bold py-2 px-4 rounded-full w-28 text-center transition-all duration-300">
                        English
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">

        <section id="intro" class="text-center mb-20">
            <h2 class="text-4xl md:text-5xl font-bold text-purple-800 mb-4" data-i18n="main.title">10.1 åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·š</h2>
            <p class="max-w-3xl mx-auto text-xl text-stone-600" data-i18n="main.subtitle">Curves Defined by Parametric Equations</p>
        </section>

        <section id="concepts" class="mb-20 scroll-mt-24">
            <h3 class="text-3xl md:text-4xl font-bold text-center mb-12 text-stone-700" data-i18n="concepts.title">ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ¸å¿ƒæ¦‚å¿µ</h3>
            <div class="space-y-10">
                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <h4 class="text-2xl font-bold mb-4 text-purple-700" data-i18n="concepts.summary.title">ğŸ¤” èª²ç¨‹æ‘˜è¦</h4>
                    <p class="text-stone-600 text-justify" data-i18n="concepts.summary.p1"></p>
                    <ul class="list-disc list-inside mt-5 space-y-4 text-stone-600">
                        <li data-i18n-html="concepts.summary.l1"></li>
                        <li data-i18n-html="concepts.summary.l2"></li>
                        <li data-i18n-html="concepts.summary.l3"></li>
                    </ul>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <h4 class="text-2xl font-bold mb-4 text-purple-700" data-i18n="concepts.objectives.title">ğŸ¯ å­¸ç¿’ç›®çš„</h4>
                     <ul class="list-disc list-inside space-y-3 text-stone-600">
                        <li class="text-justify" data-i18n="concepts.objectives.l1"></li>
                        <li class="text-justify" data-i18n="concepts.objectives.l2"></li>
                        <li class="text-justify" data-i18n="concepts.objectives.l3"></li>
                        <li class="text-justify" data-i18n="concepts.objectives.l4"></li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="examples" class="mb-16 scroll-mt-24">
            <h3 class="text-3xl md:text-4xl font-bold text-center mb-6 text-stone-700" data-i18n="examples.title">ç¬¬äºŒéƒ¨åˆ†ï¼šç¯„ä¾‹èªªæ˜</h3>
            <p class="text-center text-stone-600 max-w-3xl mx-auto mb-10 text-xl" data-i18n="examples.subtitle"></p>
            <div class="bg-white rounded-xl shadow-lg p-4 sm:p-8 border border-stone-200">
                <div id="example-tabs-container" class="flex flex-wrap gap-3 mb-8"></div>
                <div id="example-content-container"></div>
            </div>
        </section>

        <section id="practice" class="mb-16 scroll-mt-24">
            <div class="flex justify-center items-center gap-4 mb-6">
                <h3 class="text-3xl md:text-4xl font-bold text-stone-700" data-i18n="practice.title"></h3>
                <a href="Solution/10.1_solution.pdf" target="_blank" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105 text-lg" data-i18n="practice.answerButton">ç­”æ¡ˆ</a>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-stone-200 space-y-8">
                <div>
                    <h4 class="text-xl font-bold text-purple-700 mb-4" data-i18n-html="practice.q1_instruction"></h4>
                    <ol id="practice-list-1" start="3" class="space-y-2 text-stone-700 text-lg"></ol>
                </div>
                <div class="border-t pt-8">
                    <h4 class="text-xl font-bold text-purple-700 mb-4" data-i18n-html="practice.q2_instruction"></h4>
                    <ol id="practice-list-2" start="7" class="space-y-2 text-stone-700 text-lg"></ol>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-white/50 mt-16">
        <div class="container mx-auto px-8 py-6 text-center text-stone-500">
            <p data-i18n="footer.text">å¾®ç©åˆ†äº’å‹•æ•™å­¸</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="api-key-modal" class="modal-overlay">
        <div class="modal-container">
            <button id="api-key-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <div>
                <h3 class="text-2xl font-bold mb-4 text-stone-700" data-i18n="apiKeyModal.title"></h3>
                <p class="mb-4 text-stone-600" data-i18n="apiKeyModal.p1"></p>
                <input id="api-key-input" type="password" class="w-full px-4 py-3 rounded-md border-2 border-gray-300 focus:border-purple-500 focus:outline-none text-lg">
                <div class="flex justify-end gap-4 mt-6">
                    <button id="api-key-save" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-md shadow-md transition-transform transform hover:scale-105" data-i18n="apiKeyModal.save"></button>
                    <button id="api-key-modal-cancel" class="bg-stone-200 hover:bg-stone-300 text-stone-700 font-bold py-2 px-6 rounded-md shadow-md transition-transform transform hover:scale-105" data-i18n="apiKeyModal.cancel"></button>
                </div>
                 <p id="save-status" class="text-sm text-green-600 mt-2 h-4"></p>
            </div>
        </div>
    </div>
    
    <div id="ai-tutor-modal" class="modal-overlay">
        <div id="ai-tutor-modal-container" class="modal-container">
            <div id="ai-tutor-modal-header" class="w-full pb-4 border-b border-gray-200 cursor-move">
                 <h3 class="text-2xl font-bold text-purple-700" data-i18n="aiTutorModal.title"></h3>
            </div>
            <button id="ai-tutor-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <div id="ai-tutor-status" class="text-stone-700 leading-relaxed space-y-4 min-h-[50px] mt-4"></div>
            <audio id="ai-tutor-audio" class="w-full mt-4" controls></audio>
        </div>
    </div>

    <script>
    window.addEventListener('load', () => {
    
        // =================================================================
        // 1. è³‡æ–™èˆ‡ç‹€æ…‹ç®¡ç† (DATA & STATE MANAGEMENT)
        // =================================================================
        // æ‘˜è¦: æ­¤æ¨¡çµ„è² è²¬ç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„ç‹€æ…‹ (ä¾‹å¦‚ç›®å‰çš„èªè¨€) 
        // ä»¥åŠå„²å­˜æ‰€æœ‰ç¯„ä¾‹å’Œ UI æ–‡æœ¬çš„è³‡æ–™ã€‚
        
        const AppState = {
            currentLanguage: 'zh', // 'zh' æˆ– 'en'
            activeExampleIndex: 0
        };

        const Translations = {
            zh: {
                header: {
                    title: "å¾®ç©åˆ†(II)é‡è£œä¿®ç­",
                    subtitle: "æˆèª²è€å¸«:å³æ–‡éŠ“ (Prof. Wu Wen-Chuan)"
                },
                nav: { concepts: "æ ¸å¿ƒæ¦‚å¿µ", examples: "ç¯„ä¾‹èªªæ˜", practice: "è‡ªæˆ‘ç·´ç¿’" },
                main: { title: "10.1 åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·š", subtitle: "Curves Defined by Parametric Equations" },
                concepts: {
                    title: "ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ¸å¿ƒæ¦‚å¿µ",
                    summary: {
                        title: "ğŸ¤” èª²ç¨‹æ‘˜è¦",
                        p1: "åƒæ•¸æ–¹ç¨‹æ˜¯æè¿°æ›²ç·šçš„å¦ä¸€ç¨®æ–¹å¼ã€‚ç›¸è¼ƒæ–¼ä½¿ç”¨å–®ä¸€ç¬›å¡çˆ¾æ–¹ç¨‹å¼ï¼ˆå¦‚ $y=f(x)$ï¼‰ï¼Œæˆ‘å€‘å¼•å…¥ä¸€å€‹ç¨±ç‚ºã€Œåƒæ•¸ã€çš„ç¬¬ä¸‰è®Šæ•¸ï¼ˆé€šå¸¸æ˜¯ $t$ï¼‰ï¼Œä¸¦å°‡ $x$ å’Œ $y$ åæ¨™åˆ†åˆ¥è¡¨ç¤ºç‚º $t$ çš„å‡½æ•¸ã€‚",
                        l1: "<b>åƒæ•¸æ›²ç·š (Parametric Curve)</b><br>å¦‚æœ $x$ å’Œ $y$ éƒ½æ˜¯åƒæ•¸ $t$ åœ¨æŸå€‹å€é–“ $I$ ä¸Šçš„å‡½æ•¸ï¼Œå³ $x=f(t)$ å’Œ $y=g(t)$ï¼Œé‚£éº¼æ‰€æœ‰é» $(x, y) = (f(t), g(t))$ çš„é›†åˆå°±æ§‹æˆä¸€æ¢åƒæ•¸æ›²ç·šã€‚æ–¹ç¨‹å¼ $x=f(t)$ å’Œ $y=g(t)$ ç¨±ç‚ºè©²æ›²ç·šçš„åƒæ•¸æ–¹ç¨‹ã€‚",
                        l2: "<b>æç¹ªæ›²ç·š (Sketching a Curve)</b><br>æˆ‘å€‘å¯ä»¥é€éé¸æ“‡ä¸åŒçš„ $t$ å€¼ï¼Œè¨ˆç®—å°æ‡‰çš„ $(x, y)$ åæ¨™ï¼Œç„¶å¾Œå°‡é€™äº›é»åœ¨åæ¨™å¹³é¢ä¸Šé€£æ¥èµ·ä¾†ï¼Œå¾è€Œæç¹ªå‡ºæ›²ç·šçš„åœ–å½¢ã€‚$t$ å¢åŠ çš„æ–¹å‘é€šå¸¸è¡¨ç¤ºæ›²ç·šçš„ã€Œæ–¹å‘æ€§ã€(orientation)ã€‚",
                        l3: "<b>æ¶ˆå»åƒæ•¸ (Eliminating the Parameter)</b><br>æœ‰æ™‚ï¼Œæˆ‘å€‘å¯ä»¥é€éä»£æ•¸é‹ç®—ï¼ˆå¦‚ä»£å…¥æ¶ˆå»æ³•ï¼‰æˆ–ä¸‰è§’æ†ç­‰å¼å¾åƒæ•¸æ–¹ç¨‹ä¸­æ¶ˆå»åƒæ•¸ $t$ï¼Œå¾—åˆ°ä¸€å€‹åªåŒ…å« $x$ å’Œ $y$ çš„ç¬›å¡çˆ¾æ–¹ç¨‹å¼ã€‚é€™æœ‰åŠ©æ–¼æˆ‘å€‘è¾¨è­˜æ›²ç·šçš„é¡å‹ï¼ˆå¦‚ç›´ç·šã€æ‹‹ç‰©ç·šã€åœ“ç­‰ï¼‰ã€‚"
                    },
                    objectives: {
                        title: "ğŸ¯ å­¸ç¿’ç›®çš„",
                        l1: "ç†è§£åƒæ•¸æ–¹ç¨‹çš„æ¦‚å¿µï¼Œä¸¦çŸ¥é“å¦‚ä½•ç”¨å®ƒä¾†è¡¨ç¤ºå¹³é¢ä¸Šçš„æ›²ç·šã€‚",
                        l2: "èƒ½å¤ é€éä»£å…¥ä¸åŒçš„åƒæ•¸å€¼ä¾†æç¹ªåƒæ•¸æ›²ç·šçš„åœ–å½¢ï¼Œä¸¦æ¨™ç¤ºå…¶æ–¹å‘æ€§ã€‚",
                        l3: "å­¸ç¿’å¦‚ä½•å¾ä¸€çµ„åƒæ•¸æ–¹ç¨‹ä¸­æ¶ˆå»åƒæ•¸ï¼Œä»¥å¾—åˆ°å°æ‡‰çš„ç¬›å¡çˆ¾æ–¹ç¨‹å¼ã€‚",
                        l4: "èƒ½å¤ è¾¨è­˜å¸¸è¦‹æ›²ç·šï¼ˆå¦‚ç›´ç·šã€åœ“ã€æ©¢åœ“å’Œæ‹‹ç‰©ç·šï¼‰çš„åƒæ•¸æ–¹ç¨‹å½¢å¼ã€‚"
                    }
                },
                examples: {
                    title: "ç¬¬äºŒéƒ¨åˆ†ï¼šç¯„ä¾‹èªªæ˜",
                    subtitle: "è«‹é¸æ“‡é¡Œå‹ç¯„ä¾‹ã€‚æ¯å€‹ç¯„ä¾‹éƒ½å°‡å¼•å°æ‚¨å®Œæˆå¾ã€Œè§€å¯Ÿåˆ†æã€åˆ°ã€Œè§£é¡Œã€çš„å®Œæ•´æµç¨‹ã€‚",
                    analysisTitle: "è§€å¯Ÿèˆ‡åˆ†æï¼š",
                    stepsTitle: "è§£é¡Œæ­¥é©Ÿï¼š",
                    aiTutorButton: "AIåŠ©æ•™è§£èªª"
                },
                practice: {
                    title: "ç¬¬ä¸‰éƒ¨åˆ†ï¼šè‡ªæˆ‘ç·´ç¿’ (èª²æœ¬)",
                    answerButton: "ç­”æ¡ˆ",
                    q1_instruction: "é€éæé»ä¾†æç¹ªç”±åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·šã€‚ä¸¦ç”¨ç®­é ­æŒ‡å‡ºéš¨è‘— t å¢åŠ ï¼Œæ›²ç·šæ‰€æç¹ªçš„æ–¹å‘ã€‚",
                    q1_instruction_plain: "æç¹ªç”±åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·šï¼Œä¸¦ç”¨ç®­é ­æŒ‡å‡ºå…¶æ–¹å‘:",
                    q2_instruction: "(a) é€éæé»ä¾†æç¹ªç”±åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·šã€‚ä¸¦ç”¨ç®­é ­æŒ‡å‡ºéš¨è‘— t å¢åŠ ï¼Œæ›²ç·šæ‰€æç¹ªçš„æ–¹å‘ã€‚<br>(b) æ¶ˆå»åƒæ•¸ä»¥æ±‚å¾—æ›²ç·šçš„ç¬›å¡çˆ¾æ–¹ç¨‹å¼ã€‚",
                    q2_instruction_plain: "æç¹ªç”±åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·šï¼ŒæŒ‡å‡ºæ–¹å‘ï¼Œä¸¦æ¶ˆå»åƒæ•¸ä»¥æ±‚å¾—ç¬›å¡çˆ¾æ–¹ç¨‹å¼:",
                    copyButtonTitle: "è¤‡è£½é¡Œç›®",
                    copied: "å·²è¤‡è£½ï¼",
                    problems1: [
                        "$x = 1 - t^2, y = 2t - t^2, \\quad -1 \\le t \\le 2$",
                        "$x = t^3 + t, y = t^2 + 2, \\quad -2 \\le t \\le 2$",
                        "$x = 2^t - t, y = 2^{-t} + t, \\quad -3 \\le t \\le 3$",
                        "$x = \\cos^2 t, y = 1 + \\cos t, \\quad 0 \\le t \\le \\pi$"
                    ],
                    problems2: [
                        "$x = 2t - 1, y = \\frac{1}{2}t + 1$",
                        "$x = 3t + 2, y = 2t + 3$",
                        "$x = t^2 - 3, y = t + 2, \\quad -3 \\le t \\le 3$",
                        "$x = \\sin t, y = 1 - \\cos t, \\quad 0 \\le t \\le 2\\pi$",
                        "$x = \\sqrt{t}, y = 1 - t$",
                        "$x = t^2, y = t^3$"
                    ]
                },
                footer: { text: "å¾®ç©åˆ†äº’å‹•æ•™å­¸" },
                apiKeyModal: {
                    title: "è¨­å®š Google AI Studio API Key",
                    p1: "è«‹è¼¸å…¥æ‚¨çš„ API Key ä»¥å•Ÿç”¨ AI åŠ©æ•™åŠŸèƒ½ã€‚æ‚¨çš„ Key å°‡åªæœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚",
                    save: "å„²å­˜",
                    cancel: "å–æ¶ˆ"
                },
                aiTutorModal: { title: "AI åŠ©æ•™èªéŸ³è§£èªª" }
            },
            en: {
                header: {
                    title: "Calculus (II)",
                    subtitle: "Instructor: Prof. Wu Wen-Chuan"
                },
                nav: { concepts: "Core Concepts", examples: "Examples", practice: "Practice" },
                main: { title: "10.1 Curves Defined by Parametric Equations", subtitle: "åƒæ•¸æ–¹ç¨‹å®šç¾©çš„æ›²ç·š" },
                concepts: {
                    title: "Part 1: Core Concepts",
                    summary: {
                        title: "ğŸ¤” Lesson Summary",
                        p1: "Parametric equations provide another way to describe a curve. Instead of a single Cartesian equation (like $y=f(x)$), we introduce a third variable called a 'parameter' (usually $t$), and express both the $x$ and $y$ coordinates as functions of $t$.",
                        l1: "<b>Parametric Curve</b><br>If $x$ and $y$ are given as functions $x=f(t)$ and $y=g(t)$ over an interval $I$ of $t$-values, then the set of points $(x, y) = (f(t), g(t))$ is a parametric curve. The equations are parametric equations for the curve.",
                        l2: "<b>Sketching a Curve</b><br>We can sketch a parametric curve by choosing various values of $t$, calculating the corresponding $(x, y)$ coordinates, and then plotting and connecting these points. The direction of increasing $t$ gives the curve's orientation.",
                        l3: "<b>Eliminating the Parameter</b><br>Sometimes it's possible to eliminate the parameter $t$ from the equations, using algebraic manipulation (like substitution) or trigonometric identities, to obtain a Cartesian equation in $x$ and $y$. This helps us identify the shape of the curve (e.g., line, parabola, circle)."
                    },
                    objectives: {
                        title: "ğŸ¯ Learning Objectives",
                        l1: "Understand the concept of parametric equations and how they represent a curve in the plane.",
                        l2: "Be able to sketch a parametric curve by plotting points for various values of the parameter and indicating its orientation.",
                        l3: "Learn how to eliminate the parameter from a set of parametric equations to find the corresponding Cartesian equation.",
                        l4: "Be able to recognize the parametric forms of common curves like lines, circles, ellipses, and parabolas."
                    }
                },
                examples: {
                    title: "Part 2: Examples",
                    subtitle: "Select an example. Each one will guide you through the complete process from 'Analysis' to 'Solution'.",
                    analysisTitle: "Observation & Analysis:",
                    stepsTitle: "Solution Steps:",
                    aiTutorButton: "AI Tutor Explanation"
                },
                practice: {
                    title: "Part 3: Self Practice (Textbook)",
                    answerButton: "Solution",
                    q1_instruction: "Sketch the curve by using the parametric equations to plot points. Indicate with an arrow the direction in which the curve is traced as t increases.",
                    q1_instruction_plain: "Sketch the curve by using the parametric equations to plot points. Indicate with an arrow the direction in which the curve is traced as t increases:",
                    q2_instruction: "(a) Sketch the curve by using the parametric equations to plot points. Indicate with an arrow the direction in which the curve is traced as t increases.<br>(b) Eliminate the parameter to find a Cartesian equation of the curve.",
                    q2_instruction_plain: "(a) Sketch the curve... (b) Eliminate the parameter to find a Cartesian equation of the curve:",
                    copyButtonTitle: "Copy problem",
                    copied: "Copied!",
                    problems1: [
                        "$x = 1 - t^2, y = 2t - t^2, \\quad -1 \\le t \\le 2$",
                        "$x = t^3 + t, y = t^2 + 2, \\quad -2 \\le t \\le 2$",
                        "$x = 2^t - t, y = 2^{-t} + t, \\quad -3 \\le t \\le 3$",
                        // FIX: Corrected this problem to match the Chinese version for consistency.
                        "$x = \\cos^2 t, y = 1 + \\cos t, \\quad 0 \\le t \\le \\pi$"
                    ],
                    problems2: [
                        "$x = 2t - 1, y = \\frac{1}{2}t + 1$",
                        "$x = 3t + 2, y = 2t + 3$",
                        "$x = t^2 - 3, y = t + 2, \\quad -3 \\le t \\le 3$",
                        "$x = \\sin t, y = 1 - \\cos t, \\quad 0 \\le t \\le 2\\pi$",
                        "$x = \\sqrt{t}, y = 1 - t$",
                        "$x = t^2, y = t^3$"
                    ]
                },
                footer: { text: "Interactive Calculus Tutorial" },
                apiKeyModal: {
                    title: "Set Google AI Studio API Key",
                    p1: "Please enter your API Key to enable the AI Tutor feature. Your key will be stored only in your browser.",
                    save: "Save",
                    cancel: "Cancel"
                },
                aiTutorModal: { title: "AI Tutor Voice Explanation" }
            }
        };
        
        const ExamplesData = [
            {
                title: { zh: 'æç¹ªæ‹‹ç‰©ç·š', en: 'Sketching a Parabola'},
                problem: { zh: 'æç¹ªä¸¦è¾¨è­˜ç”±åƒæ•¸æ–¹ç¨‹ $x = t^2 - 2t, y = t + 1$ å®šç¾©çš„æ›²ç·šã€‚', en: 'Sketch and identify the curve defined by the parametric equations $x = t^2 - 2t, y = t + 1$.'},
                source: 'p.662 Example 1',
                analysis: {
                    zh: 'ç‚ºäº†è¾¨è­˜æ›²ç·šçš„å½¢ç‹€ï¼Œæˆ‘å€‘å¯ä»¥å˜—è©¦æ¶ˆå»åƒæ•¸ $t$ã€‚å¾ç¬¬äºŒå€‹æ–¹ç¨‹å¼å¯ä»¥å¾ˆè¼•æ˜“åœ°è§£å‡º $t$ï¼Œç„¶å¾Œå°‡å…¶ä»£å…¥ç¬¬ä¸€å€‹æ–¹ç¨‹å¼ï¼Œå¾—åˆ°ä¸€å€‹åªåŒ…å« $x$ å’Œ $y$ çš„é—œä¿‚å¼ã€‚',
                    en: 'To identify the shape of the curve, we can try to eliminate the parameter $t$. It is easy to solve for $t$ from the second equation and then substitute it into the first equation to get a relationship between $x$ and $y$.'
                },
                steps: [
                    {
                        title: { zh: 'æ­¥é©Ÿ 1ï¼šè§£å‡ºåƒæ•¸ t', en: 'Step 1: Solve for the parameter t'},
                        content: { zh: `å¾ç¬¬äºŒå€‹æ–¹ç¨‹å¼ $y = t + 1$ ä¸­ï¼Œæˆ‘å€‘å¯ä»¥å¾—åˆ°ï¼š $$t = y - 1$$`, en: `From the second equation, $y = t + 1$, we get: $$t = y - 1$$` }
                    },
                    {
                        title: { zh: 'æ­¥é©Ÿ 2ï¼šä»£å…¥ä¸¦åŒ–ç°¡', en: 'Step 2: Substitute and Simplify' },
                        content: { zh: `å°‡ $t = y - 1$ ä»£å…¥ $x$ çš„æ–¹ç¨‹å¼ï¼š $$x = (y-1)^2 - 2(y-1)$$ $$x = (y^2 - 2y + 1) - (2y - 2)$$ $$x = y^2 - 4y + 3$$`, en: `Substitute $t = y - 1$ into the equation for $x$: $$x = (y-1)^2 - 2(y-1)$$ $$x = (y^2 - 2y + 1) - (2y - 2)$$ $$x = y^2 - 4y + 3$$` }
                    },
                    {
                        title: { zh: 'æ­¥é©Ÿ 3ï¼šè¾¨è­˜æ›²ç·š', en: 'Step 3: Identify the Curve' },
                        content: { 
                            zh: `æ–¹ç¨‹å¼ $x = y^2 - 4y + 3$ ä»£è¡¨ä¸€å€‹æ°´å¹³é–‹å£çš„æ‹‹ç‰©ç·šã€‚æˆ‘å€‘å¯ä»¥é€éé…æ–¹æ³•æ‰¾åˆ°å…¶é ‚é»ï¼š$x = (y-2)^2 - 1$ã€‚é ‚é»ä½æ–¼ $(-1, 2)$ã€‚
                            <img src="10.1_1.png" alt="åœ–1" class="mx-auto max-w-sm">`,
                            en: `The equation $x = y^2 - 4y + 3$ represents a parabola that opens to the right. We can find its vertex by completing the square: $x = (y-2)^2 - 1$. The vertex is at $(-1, 2).
                            <img src="10.1_1.png" alt="åœ–1" class="mx-auto max-w-sm">`
                        }
                    }
                ]
            },
            {
                title: { zh: 'è¾¨è­˜å–®ä½åœ“', en: 'Identifying the Unit Circle'},
                problem: { zh: 'ç”±åƒæ•¸æ–¹ç¨‹ $x = \\cos t, y = \\sin t, 0 \\le t \\le 2\\pi$ ä»£è¡¨çš„æ›²ç·šæ˜¯ä»€éº¼ï¼Ÿ', en: 'What curve is represented by the parametric equations $x = \\cos t, y = \\sin t, 0 \\le t \\le 2\\pi$?'},
                source: 'p.664 Example 2',
                analysis: {
                    zh: 'ç•¶åƒæ•¸æ–¹ç¨‹æ¶‰åŠä¸‰è§’å‡½æ•¸ $\\sin$ å’Œ $\\cos$ æ™‚ï¼Œä¸€å€‹å¸¸ç”¨çš„æŠ€å·§æ˜¯åˆ©ç”¨ä¸‰è§’æ†ç­‰å¼ $\\sin^2 t + \\cos^2 t = 1$ ä¾†æ¶ˆå»åƒæ•¸ $t$ã€‚',
                    en: 'When parametric equations involve trigonometric functions like $\\sin$ and $\\cos$, a common technique is to use the identity $\\sin^2 t + \\cos^2 t = 1$ to eliminate the parameter $t$.'
                },
                steps: [
                    {
                        title: { zh: 'æ­¥é©Ÿ 1ï¼šåˆ©ç”¨ä¸‰è§’æ†ç­‰å¼', en: 'Step 1: Use the Trigonometric Identity' },
                        content: { zh: `æˆ‘å€‘æœ‰ $x^2 + y^2 = (\\cos t)^2 + (\\sin t)^2$ã€‚æ ¹æ“šç•¢æ°ä¸‰è§’æ†ç­‰å¼ï¼Œæˆ‘å€‘çŸ¥é“ï¼š $$x^2 + y^2 = 1$$`, en: `We have $x^2 + y^2 = (\\cos t)^2 + (\\sin t)^2$. According to the Pythagorean trigonometric identity, we know that: $$x^2 + y^2 = 1$$` }
                    },
                    {
                        title: { zh: 'æ­¥é©Ÿ 2ï¼šè¾¨è­˜æ›²ç·šèˆ‡æ–¹å‘', en: 'Step 2: Identify the Curve and Orientation' },
                        content: { 
                            zh: `æ–¹ç¨‹å¼ $x^2 + y^2 = 1$ æ˜¯åœ“å¿ƒåœ¨åŸé» $(0,0)$ã€åŠå¾‘ç‚º 1 çš„å–®ä½åœ“ã€‚<br>ç•¶åƒæ•¸ $t$ å¾ $0$ å¢åŠ åˆ° $2\\pi$ï¼Œé» $(x,y)$ å¾ $(1,0)$ é–‹å§‹ï¼Œæ²¿è‘—åœ“é€†æ™‚é‡ç§»å‹•ä¸€æ•´åœˆï¼Œæœ€å¾Œå›åˆ° $(1,0)$ã€‚
                            <img src="10.1_2.png" alt="åœ–2" class="mx-auto max-w-sm">`,
                            en: `The equation $x^2 + y^2 = 1$ is the unit circle, centered at the origin $(0,0)$ with a radius of 1.<br>As the parameter $t$ increases from $0$ to $2\\pi$, the point $(x,y)$ starts at $(1,0)$ and moves counterclockwise around the entire circle, returning to $(1,0).
                            <img src="10.1_2.png" alt="åœ–2" class="mx-auto max-w-sm">`
                        }
                    }
                ]
            },
            {
                title: { zh: 'é‡è¤‡æç¹ªçš„æ›²ç·š', en: 'A Curve Traced Multiple Times' },
                problem: { zh: 'ç”±åƒæ•¸æ–¹ç¨‹ $x = \\sin 2t, y = \\cos 2t, 0 \\le t \\le 2\\pi$ ä»£è¡¨çš„æ›²ç·šæ˜¯ä»€éº¼ï¼Ÿ', en: 'What curve is represented by the given parametric equations $x = \\sin 2t, y = \\cos 2t, 0 \\le t \\le 2\\pi$?' },
                source: 'p.662 Example 3',
                analysis: {
                    zh: 'é€™å€‹ç¯„ä¾‹èˆ‡å‰ä¸€é¡Œéå¸¸ç›¸ä¼¼ã€‚æˆ‘å€‘åŒæ¨£å¯ä»¥ä½¿ç”¨ $\\sin^2 \\theta + \\cos^2 \\theta = 1$ é€™å€‹æ†ç­‰å¼ï¼Œå…¶ä¸­ $\\theta = 2t$ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åƒæ•¸çš„ä¿‚æ•¸æœƒå¦‚ä½•å½±éŸ¿æ›²ç·šçš„æç¹ªéç¨‹ã€‚',
                    en: 'This example is very similar to the previous one. We can again use the identity $\\sin^2 \\theta + \\cos^2 \\theta = 1$, where $\\theta = 2t$. It is important to note how the coefficient of the parameter affects how the curve is traced.'
                },
                steps: [
                     {
                        title: { zh: 'æ­¥é©Ÿ 1ï¼šæ¶ˆå»åƒæ•¸', en: 'Step 1: Eliminate the Parameter' },
                        content: { zh: `$$x^2 + y^2 = (\\sin 2t)^2 + (\\cos 2t)^2 = 1$$ åŒæ¨£åœ°ï¼Œæˆ‘å€‘å¾—åˆ°å–®ä½åœ“çš„æ–¹ç¨‹å¼ $x^2+y^2=1$ã€‚`, 
                                 en: `$$x^2 + y^2 = (\\sin 2t)^2 + (\\cos 2t)^2 = 1$$ Again, we obtain the equation of the unit circle, $x^2+y^2=1$.` }
                    },
                    {
                        title: { zh: 'æ­¥é©Ÿ 2ï¼šåˆ†ææç¹ªéç¨‹', en: 'Step 2: Analyze the Tracing Process' },
                        content: { zh: `é›–ç„¶æ›²ç·šæ˜¯å–®ä½åœ“ï¼Œä½†ç”±æ–¼åƒæ•¸æ˜¯ $2t$ï¼Œç•¶ $t$ å¾ $0$ å¢åŠ åˆ° $\\pi$ æ™‚ï¼Œ$2t$ å°±å¾ $0$ å¢åŠ åˆ° $2\\pi$ï¼Œé€™æ„å‘³è‘—é» $(x,y)$ å·²ç¶“å®Œæ•´åœ°ç¹äº†åœ“ä¸€åœˆã€‚<br>å› æ­¤ï¼Œç•¶ $t$ å¾ $0$ å¢åŠ åˆ° $2\\pi$ æ™‚ï¼Œé€™å€‹å–®ä½åœ“æœƒè¢«å®Œæ•´åœ°æç¹ªå…©æ¬¡ã€‚
                                         <img src="10.1_3.png" alt="åœ–3" class="mx-auto max-w-sm">`, 
                                 en: `Although the curve is the unit circle, because the parameter is $2t$, as $t$ increases from $0$ to $\\pi$, $2t$ increases from $0$ to $2\\pi$. This means the point $(x,y)$ has already traced the entire circle once.<br>Therefore, as $t$ increases from $0$ to $2\\pi$, the unit circle is traced completely twice.
                                         <img src="10.1_3.png" alt="åœ–3" class="mx-auto max-w-sm">` }
                    }
                ]
            }
        ];
        
        // =================================================================
        // 2. UI æ¸²æŸ“æ¨¡çµ„ (UI RENDERING MODULE)
        // =================================================================
        // æ‘˜è¦: æ­¤æ¨¡çµ„è² è²¬æ‰€æœ‰ DOM æ“ä½œï¼ŒåŒ…æ‹¬æ ¹æ“šç›®å‰çš„èªè¨€æ¸²æŸ“é ç±¤ã€
        // ç¯„ä¾‹å…§å®¹ä»¥åŠæ›´æ–°éœæ…‹æ–‡æœ¬ã€‚
        
        const UIRenderer = {
            async init() {
                this.updateAllText(AppState.currentLanguage);
                this.renderTabs(AppState.currentLanguage);
                this.renderExampleContent(AppState.activeExampleIndex, AppState.currentLanguage);
                this.renderPracticeProblems(AppState.currentLanguage);
                await MathJax.typesetPromise();
            },
            
            updateAllText(lang) {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    const translation = key.split('.').reduce((obj, k) => obj && obj[k], Translations[lang]);
                    if (translation) {
                        el.textContent = translation;
                    }
                });
                
                 document.querySelectorAll('[data-i18n-html]').forEach(el => {
                    const key = el.dataset.i18nHtml;
                    const translation = key.split('.').reduce((obj, k) => obj && obj[k], Translations[lang]);
                    if (translation) {
                        el.innerHTML = translation;
                    }
                });
                
                // æ›´æ–°ç‰¹å®šå…ƒç´ ï¼Œå¦‚ placeholder
                const apiKeyInput = document.getElementById('api-key-input');
                apiKeyInput.placeholder = lang === 'zh' ? 'è«‹åœ¨æ­¤è¼¸å…¥ API Key' : 'Enter API Key here';
            },

            renderTabs(lang) {
                const container = document.getElementById('example-tabs-container');
                container.innerHTML = ExamplesData.map((ex, i) => {
                    const title = ex.title[lang] || ex.title['en'];
                    return `<button data-index="${i}" class="tab-button text-base sm:text-lg py-3 px-5 rounded-lg transition duration-300 ${i === AppState.activeExampleIndex ? 'active-tab' : 'inactive-tab'}">${title}</button>`;
                }).join('');

                container.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const newIndex = parseInt(e.currentTarget.dataset.index);
                        AppState.activeExampleIndex = newIndex;
                        this.renderTabs(lang);
                        this.renderExampleContent(newIndex, lang);
                    });
                });
            },

            async renderExampleContent(index, lang) {
                const container = document.getElementById('example-content-container');
                const example = ExamplesData[index];
                const t = Translations[lang].examples;

                const stepsHtml = example.steps.map((step, i) => `
                    <div class="border-b border-stone-200 last:border-b-0">
                        <button class="accordion-header w-full text-left p-5 focus:outline-none hover:bg-purple-50 transition duration-300 flex justify-between items-center">
                            <span class="font-semibold text-lg text-stone-700">${step.title[lang]}</span>
                            <svg class="w-6 h-6 text-purple-600 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-5 bg-stone-50 border-t border-stone-200 text-stone-600 leading-relaxed math-display">${step.content[lang]}</div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="mb-8">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                             <h4 class="text-2xl font-bold text-stone-800">${example.title[lang]}</h4>
                             <button id="ai-tutor-button" data-index="${index}" class="ai-tutor-btn flex items-center justify-center gap-2 bg-purple-500 text-white font-bold py-3 px-5 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:opacity-70 disabled:cursor-not-allowed">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
                                 <span>${t.aiTutorButton}</span>
                             </button>
                        </div>
                        <div class="p-5 bg-amber-100/70 rounded-lg text-xl math-display">${example.problem[lang]}</div>
                        ${example.source ? `<p class="mt-2 text-base text-stone-500 text-right font-en">${example.source}</p>` : ''}
                    </div>
                    <div class="mb-8">
                        <h4 class="text-2xl font-bold text-stone-800 mb-3">${t.analysisTitle}</h4>
                        <p class="p-5 bg-sky-100/70 rounded-lg text-stone-600">${example.analysis[lang]}</p>
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold text-stone-800 mb-3">${t.stepsTitle}</h4>
                        <div class="border border-stone-200 rounded-lg overflow-hidden">${stepsHtml}</div>
                    </div>
                `;
                
                this.attachEventListeners();
                // è§¸ç™¼ MathJax é‡æ–°æ¸²æŸ“æ–°çš„å…§å®¹
                await MathJax.typesetPromise();
            },
            
            renderPracticeProblems(lang) {
                const t = Translations[lang].practice;
                if (!document.getElementById('practice')) return; 

                const copyIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

                const populateList = (element, problems, instruction) => {
                    if (element) {
                        const startNum = parseInt(element.getAttribute('start') || '1', 10);
                        element.innerHTML = problems.map((problem, index) => {
                            const itemNumber = startNum + index;
                            const cleanProblem = problem.replace(/\$/g, '').replace(/<[^>]*>/g, '').replace(/\\quad/g, ' ').replace(/\\/g, '');
                            const copyText = `${instruction} ${itemNumber}. ${cleanProblem}`;
                            return `<li class="flex justify-between items-center">
                                        <div class="flex-grow">
                                            <span class="font-bold mr-2">${itemNumber}.</span>
                                            <span>${problem}</span>
                                        </div>
                                        <button data-copy-text="${copyText}" class="copy-btn p-1 ml-4 flex-shrink-0 rounded-md hover:bg-purple-100" title="${t.copyButtonTitle}">
                                            ${copyIconSvg}
                                        </button>
                                    </li>`;
                        }).join('');
                    }
                };

                populateList(
                    document.getElementById('practice-list-1'),
                    t.problems1,
                    t.q1_instruction_plain
                );
                populateList(
                    document.getElementById('practice-list-2'),
                    t.problems2,
                    t.q2_instruction_plain
                );
            },

            attachEventListeners() {
                // æ‰‹é¢¨ç´ (Accordion) é‚è¼¯
                document.querySelectorAll('#example-content-container .accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.nextElementSibling.classList.toggle('show');
                        header.querySelector('svg').classList.toggle('rotate-180');
                    });
                });
                
                // AI åŠ©æ•™æŒ‰éˆ•é‚è¼¯
                const aiTutorButton = document.getElementById('ai-tutor-button');
                const apiKey = localStorage.getItem('googleApiKey');
                if (!apiKey) {
                    aiTutorButton.disabled = true;
                    aiTutorButton.title = AppState.currentLanguage === 'zh' ? 'è«‹å…ˆè¨­å®š API Key' : 'Please set API Key first';
                }
                aiTutorButton.addEventListener('click', (e) => {
                    AITutor.handleRequest(e.currentTarget.dataset.index, AppState.currentLanguage);
                });
            }
        };

        // =================================================================
        // 3. å½ˆå‡ºè¦–çª—ç®¡ç†æ¨¡çµ„ (MODAL MANAGEMENT MODULE)
        // =================================================================
        // æ‘˜è¦: è™•ç†æ‰€æœ‰èˆ‡å½ˆå‡ºè¦–çª—ç›¸é—œçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬é–‹å•Ÿã€é—œé–‰ï¼Œ
        // ä»¥åŠè®“è¦–çª—å¯æ‹–å‹•ã€‚
        
        const ModalManager = {
            init() {
                this.apiKeyModal = document.getElementById('api-key-modal');
                this.aiTutorModal = document.getElementById('ai-tutor-modal');
                
                this.setupModal(this.apiKeyModal, 'api-key-modal-trigger', 'api-key-modal-close');
                this.setupModal(this.aiTutorModal, null, 'ai-tutor-modal-close');
                
                document.getElementById('api-key-modal-cancel').addEventListener('click', () => this.apiKeyModal.classList.remove('show'));
                document.getElementById('api-key-save').addEventListener('click', this.saveApiKey.bind(this));

                this.makeDraggable(document.getElementById('ai-tutor-modal-container'), document.getElementById('ai-tutor-modal-header'));
            },

            setupModal(modal, triggerId, closeButtonId) {
                const trigger = document.getElementById(triggerId);
                const closeBtn = document.getElementById(closeButtonId);
                
                const openModal = () => modal.classList.add('show');
                const closeModal = () => {
                    modal.classList.remove('show');
                    if (modal.id === 'ai-tutor-modal') {
                        const audioPlayer = document.getElementById('ai-tutor-audio');
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                    }
                };

                if (trigger) trigger.addEventListener('click', openModal);
                if (closeBtn) closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            },
            
            saveApiKey() {
                const apiKeyInput = document.getElementById('api-key-input');
                const saveStatus = document.getElementById('save-status');
                const key = apiKeyInput.value.trim();
                
                if (key) {
                    localStorage.setItem('googleApiKey', key);
                    saveStatus.textContent = AppState.currentLanguage === 'zh' ? 'API Key å·²å„²å­˜ï¼' : 'API Key saved!';
                } else {
                    localStorage.removeItem('googleApiKey');
                    saveStatus.textContent = AppState.currentLanguage === 'zh' ? 'API Key å·²æ¸…é™¤ã€‚' : 'API Key cleared.';
                }
                
                UIRenderer.renderExampleContent(AppState.activeExampleIndex, AppState.currentLanguage);
                setTimeout(() => {
                    this.apiKeyModal.classList.remove('show');
                    saveStatus.textContent = '';
                }, 1000);
            },
            
            makeDraggable(modal, header) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                header.onmousedown = (e) => {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                    document.onmousemove = (ev) => {
                        ev.preventDefault();
                        pos1 = pos3 - ev.clientX;
                        pos2 = pos4 - ev.clientY;
                        pos3 = ev.clientX;
                        pos4 = ev.clientY;
                        modal.style.top = (modal.offsetTop - pos2) + "px";
                        modal.style.left = (modal.offsetLeft - pos1) + "px";
                        modal.style.transform = 'none'; 
                    };
                };
            }
        };

        // =================================================================
        // 4. AI åŠ©æ•™æ¨¡çµ„ (AI TUTOR MODULE)
        // =================================================================
        // æ‘˜è¦: æ­¤æ¨¡çµ„è™•ç†æ‰€æœ‰èˆ‡ Google AI API çš„äº’å‹•ï¼ŒåŒ…æ‹¬ç”Ÿæˆ
        // æ–‡å­—è§£é‡‹ä¸¦å°‡å…¶è½‰æ›ç‚ºèªéŸ³ã€‚
        
        const AITutor = {
            async handleRequest(index, lang) {
                const apiKey = localStorage.getItem('googleApiKey');
                if (!apiKey) return;
                
                const example = ExamplesData[index];
                const stepsText = example.steps.map(s => `${s.title[lang]}:\n${s.content[lang].replace(/<br>/g, '\n').replace(/<[^>]*>/g, '')}`).join('\n\n');
                const prompt = `Problem:\n${example.problem[lang].replace(/<[^>]*>/g, '')}\n\nAnalysis:\n${example.analysis[lang]}\n\nSolution Steps:\n${stepsText}`;
                
                const systemPrompt = lang === 'zh'
                    ? "ä½ æ˜¯ä¸€ä½è¦ªåˆ‡çš„å¾®ç©åˆ†åŠ©æ•™ã€‚è«‹ç”¨ç°¡å–®æ˜“æ‡‚ã€å£èªåŒ–çš„æ–¹å¼ï¼Œè§£èªªä»¥ä¸‹çš„å¾®ç©åˆ†é¡Œç›®ã€‚è«‹å…ˆè§£é‡‹è§£é¡Œçš„æ€è·¯ï¼Œç„¶å¾Œé€æ­¥èªªæ˜è§£é¡Œéç¨‹ã€‚"
                    : "You are a friendly calculus tutor. Explain the following calculus problem in a simple, conversational way. First, explain the overall thinking process, then walk through the solution steps.";

                this.generateExplanation(prompt, systemPrompt, apiKey);
            },
            
            async _fetchWithRetry(url, options, maxRetries = 4) {
                let lastError;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) {
                            return response;
                        }
                        // Only retry on server errors or rate limiting
                        if (response.status === 429 || response.status >= 500) {
                            lastError = new Error(`API request failed with status ${response.status}`);
                        } else {
                            // Don't retry on other client errors (e.g., 400 Bad Request)
                            const errorBody = await response.text();
                            throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                        }
                    } catch (error) {
                        lastError = error;
                    }
                    // Wait with exponential backoff and jitter
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                throw lastError;
            },

            async generateExplanation(prompt, systemPrompt, apiKey) {
                const statusEl = document.getElementById('ai-tutor-status');
                const audioEl = document.getElementById('ai-tutor-audio');
                const modal = document.getElementById('ai-tutor-modal');
                
                // é‡è¨­ä¸¦é¡¯ç¤ºå½ˆå‡ºè¦–çª—
                const modalContainer = document.getElementById('ai-tutor-modal-container');
                modalContainer.style.top = '50%';
                modalContainer.style.left = '50%';
                modalContainer.style.transform = 'translate(-50%, -50%)';
                statusEl.innerHTML = `<p>${AppState.currentLanguage === 'zh' ? 'AI åŠ©æ•™æ€è€ƒä¸­...' : 'AI Tutor is thinking...'}<span class="blinking-cursor"></span></p>`;
                audioEl.src = '';
                audioEl.hidden = true;
                modal.classList.add('show');
                
                const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                try {
                    const textPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const textResponse = await this._fetchWithRetry(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(textPayload) });
                    const textResult = await textResponse.json();
                    const explanationText = textResult.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!explanationText) throw new Error('Could not get valid text content from API.');
                    
                    statusEl.innerHTML = `<p>${AppState.currentLanguage === 'zh' ? 'æ­£åœ¨ç‚ºæ‚¨ç”¢ç”ŸèªéŸ³...' : 'Generating audio for you...'}<span class="blinking-cursor"></span></p>`;
                    
                    const ttsPayload = {
                        contents: [{ parts: [{ text: explanationText }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Sadaltager" } } }
                        }
                    };
                    const audioResponse = await this._fetchWithRetry(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ttsPayload) });
                    const audioResult = await audioResponse.json();
                    const audioData = audioResult?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    const mimeType = audioResult?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = this._base64ToArrayBuffer(audioData);
                        const wavBlob = this._pcmToWav(new Int16Array(pcmData), sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        statusEl.innerHTML = `<p>${AppState.currentLanguage === 'zh' ? 'èªéŸ³è§£èªªå·²å°±ç·’ï¼' : 'Voice explanation is ready!'}</p>`;
                        audioEl.src = audioUrl;
                        audioEl.hidden = false;
                        audioEl.play();
                    } else {
                        throw new Error('Could not get valid audio content from API.');
                    }
                } catch (error) {
                    console.error("AI Tutor Error:", error);
                    statusEl.innerHTML = `<p class="text-red-600">${AppState.currentLanguage === 'zh' ? 'æŠ±æ­‰ï¼ŒAI åŠ©æ•™å‡ºäº†ä¸€é»å•é¡Œï¼š' : 'Sorry, the AI tutor ran into an issue:'}<br>${error.message}</p><p class="text-sm mt-2">${AppState.currentLanguage === 'zh' ? 'è«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºä¸”æœ‰è¶³å¤ çš„æ¬Šé™ã€‚' : 'Please check if your API Key is correct and has sufficient permissions.'}</p>`;
                }
            },
            
            _base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            },

            _pcmToWav(pcmData, sampleRate) {
                const dataSize = pcmData.length * 2;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                view.setUint32(0, 0x52494646, false); // "RIFF"
                view.setUint32(4, 36 + dataSize, true);
                view.setUint32(8, 0x57415645, false); // "WAVE"
                view.setUint32(12, 0x666d7420, false); // "fmt "
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true); // numChannels
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, samplerate * 2, true); // byteRate
                view.setUint16(32, 2, true); // blockAlign
                view.setUint16(34, 16, true); // bitsPerSample
                view.setUint32(36, 0x64617461, false); // "data"
                view.setUint32(40, dataSize, true);
                let offset = 44;
                for (let i = 0; i < pcmData.length; i++, offset += 2) {
                    view.setInt16(offset, pcmData[i], true);
                }
                return new Blob([view], { type: 'audio/wav' });
            }
        };

        // =================================================================
        // 5. æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– (APPLICATION INITIALIZATION)
        // =================================================================
        // æ‘˜è¦: é€™æ˜¯æ‡‰ç”¨ç¨‹å¼çš„ä¸»è¦é€²å…¥é»ã€‚å®ƒæœƒåˆå§‹åŒ–æ‰€æœ‰æ¨¡çµ„ä¸¦
        // è¨­å®šåˆå§‹çš„äº‹ä»¶ç›£è½å™¨ã€‚
        
        async function main() {
            const langToggleButton = document.getElementById('lang-toggle');
            
            langToggleButton.addEventListener('click', async () => {
                AppState.currentLanguage = AppState.currentLanguage === 'zh' ? 'en' : 'zh';
                langToggleButton.textContent = AppState.currentLanguage === 'zh' ? 'English' : 'ç¹é«”ä¸­æ–‡';
                
                document.documentElement.lang = AppState.currentLanguage === 'zh' ? 'zh-Hant' : 'en';

                // æ­£ç¢ºåœ°ç®¡ç† body çš„ class ä»¥åˆ‡æ›å­—é«”æ¨£å¼
                document.body.classList.remove('font-zh', 'font-en');
                if (AppState.currentLanguage === 'zh') {
                    document.body.classList.add('font-zh');
                } else {
                    document.body.classList.add('font-en');
                }

                await UIRenderer.init();
            });

            // åˆå§‹è¨­å®š
            ModalManager.init();
            await UIRenderer.init();

            // ç‚ºç·´ç¿’å€å¡Šè¨­å®šè¤‡è£½äº‹ä»¶ç›£è½å™¨
            function copyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('ç„¡æ³•è¤‡è£½é¡Œç›®:', err);
                }
                document.body.removeChild(textArea);
            }

            const practiceSection = document.getElementById('practice');
            if (practiceSection) {
                practiceSection.addEventListener('click', function(e) {
                    const copyBtn = e.target.closest('.copy-btn');
                    if (copyBtn) {
                        const textToCopy = copyBtn.dataset.copyText;
                        copyToClipboard(textToCopy);

                        // Visual feedback
                        const lang = AppState.currentLanguage;
                        const copiedText = Translations[lang].practice.copied;
                        const originalTitle = Translations[lang].practice.copyButtonTitle;
                        const checkIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                        const originalIcon = copyBtn.innerHTML;

                        copyBtn.innerHTML = checkIconSvg;
                        copyBtn.title = copiedText;
                        copyBtn.disabled = true;

                        setTimeout(() => {
                            copyBtn.innerHTML = originalIcon;
                            copyBtn.title = originalTitle;
                            copyBtn.disabled = false;
                        }, 1500);
                    }
                });
            }
        }

        main();
    });
    </script>
</body>
</html>





