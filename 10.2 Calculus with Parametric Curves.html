<!DOCTYPE html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微積分(II) - 10.2 參數曲線的微積分</title>
    <script type="text/javascript">
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: #fff7f9; /* Soft Pink */
            color: #5c524f; /* Muted Brown */
        }
        .font-zh { font-family: 'Noto Sans TC', sans-serif; }
        .font-en { font-family: 'Poppins', sans-serif; }
        .math-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0.25rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .math-display::-webkit-scrollbar { display: none; }
        .active-tab {
            background-color: #d8b4fe; /* Lavender */
            color: #4c1d95; /* Deep Purple */
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .inactive-tab {
            background-color: #f3e8ff; /* Light Lavender */
            color: #6b21a8; /* Purple */
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-content.show { max-height: 2000px; }
        .rotate-180 { transform: rotate(180deg); }
        .text-justify { text-align: justify; }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            pointer-events: auto;
        }
        .modal-overlay.show .modal-container { transform: translate(-50%, -50%) scale(1); }
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1.5rem;
            background-color: #5c524f;
            animation: blink 1s step-end infinite;
            margin-left: 2px;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #5c524f; }
        }
    </style>
</head>
<body class="text-lg font-zh">

    <header class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-purple-700 font-zh" data-i18n="header.title">
                        微積分(II)重補修班
                    </h1>
                    <p class="text-base text-stone-500 font-en" data-i18n="header.subtitle">授課老師:吳文銓 (Prof. Wu Wen-Chuan)</p>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="#concepts" class="text-stone-600 hover:bg-purple-200 hover:text-purple-800 px-3 py-2 rounded-md text-base font-medium" data-i18n="nav.concepts">核心概念</a>
                    <a href="#examples" class="text-stone-600 hover:bg-purple-200 hover:text-purple-800 px-3 py-2 rounded-md text-base font-medium" data-i18n="nav.examples">範例說明</a>
                    <a href="#practice" class="text-stone-600 hover:bg-purple-200 hover:text-purple-800 px-3 py-2 rounded-md text-base font-medium" data-i18n="nav.practice">自我練習</a>
                    <button id="api-key-modal-trigger" class="text-stone-500 hover:text-purple-600 transition-colors duration-200" title="Set AI API Key">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"></path><circle cx="16.5" cy="7.5" r=".5"></circle></svg>
                    </button>
                    <button id="lang-toggle" class="bg-purple-100 text-purple-700 font-bold py-2 px-4 rounded-full w-28 text-center transition-all duration-300">
                        English
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">

        <section id="intro" class="text-center mb-20">
            <h2 class="text-4xl md:text-5xl font-bold text-purple-800 mb-4" data-i18n="main.title">10.2 參數曲線的微積分</h2>
            <p class="max-w-3xl mx-auto text-xl text-stone-600" data-i18n="main.subtitle">Calculus with Parametric Curves</p>
        </section>

        <section id="concepts" class="mb-20 scroll-mt-24">
            <h3 class="text-3xl md:text-4xl font-bold text-center mb-12 text-stone-700" data-i18n="concepts.title">第一部分：核心概念</h3>
            <div class="space-y-10">
                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <h4 class="text-2xl font-bold mb-4 text-purple-700" data-i18n="concepts.summary.title">🤔 課程摘要</h4>
                    <p class="text-stone-600 text-justify" data-i18n="concepts.summary.p1"></p>
                    <ul class="list-disc list-inside mt-5 space-y-4 text-stone-600">
                        <li data-i18n-html="concepts.summary.l1"></li>
                        <li data-i18n-html="concepts.summary.l2"></li>
                        <li data-i18n-html="concepts.summary.l3"></li>
                    </ul>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <h4 class="text-2xl font-bold mb-4 text-purple-700" data-i18n="concepts.objectives.title">🎯 學習目的</h4>
                     <ul class="list-disc list-inside space-y-3 text-stone-600">
                        <li class="text-justify" data-i18n="concepts.objectives.l1"></li>
                        <li class="text-justify" data-i18n="concepts.objectives.l2"></li>
                        <li class="text-justify" data-i18n="concepts.objectives.l3"></li>
                        <li class="text-justify" data-i18n="concepts.objectives.l4"></li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="examples" class="mb-16 scroll-mt-24">
            <h3 class="text-3xl md:text-4xl font-bold text-center mb-6 text-stone-700" data-i18n="examples.title">第二部分：範例說明</h3>
            <p class="text-center text-stone-600 max-w-3xl mx-auto mb-10 text-xl" data-i18n="examples.subtitle"></p>
            <div class="bg-white rounded-xl shadow-lg p-4 sm:p-8 border border-stone-200">
                <div id="example-tabs-container" class="flex flex-wrap gap-3 mb-8"></div>
                <div id="example-content-container"></div>
            </div>
        </section>

        <section id="practice" class="mb-16 scroll-mt-24">
            <div class="flex justify-center items-center gap-4 mb-6">
                <h3 class="text-3xl md:text-4xl font-bold text-stone-700" data-i18n="practice.title"></h3>
                <a href="Solution/10.2_solution.pdf" target="_blank" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-transform transform hover:scale-105 text-lg" data-i18n="practice.answerButton">答案</a>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-stone-200 space-y-8">
                <div>
                    <h4 class="text-xl font-bold text-purple-700 mb-4" data-i18n-html="practice.q1_instruction"></h4>
                    <ol id="practice-list-1" class="space-y-2 text-stone-700 text-lg"></ol>
                </div>
                <div class="border-t pt-8">
                    <h4 class="text-xl font-bold text-purple-700 mb-4" data-i18n-html="practice.q2_instruction"></h4>
                    <ol id="practice-list-2" start="7" class="space-y-2 text-stone-700 text-lg"></ol>
                </div>
                <div class="border-t pt-8">
                    <h4 class="text-xl font-bold text-purple-700 mb-4" data-i18n-html="practice.q3_instruction"></h4>
                    <ol id="practice-list-3" start="11" class="space-y-2 text-stone-700 text-lg"></ol>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-white/50 mt-16">
        <div class="container mx-auto px-8 py-6 text-center text-stone-500">
            <p data-i18n="footer.text">微積分互動教學</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="api-key-modal" class="modal-overlay">
        <div class="modal-container">
            <button id="api-key-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <div>
                <h3 class="text-2xl font-bold mb-4 text-stone-700" data-i18n="apiKeyModal.title"></h3>
                <p class="mb-4 text-stone-600" data-i18n="apiKeyModal.p1"></p>
                <input id="api-key-input" type="password" class="w-full px-4 py-3 rounded-md border-2 border-gray-300 focus:border-purple-500 focus:outline-none text-lg">
                <div class="flex justify-end gap-4 mt-6">
                    <button id="api-key-save" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-md shadow-md transition-transform transform hover:scale-105" data-i18n="apiKeyModal.save"></button>
                    <button id="api-key-modal-cancel" class="bg-stone-200 hover:bg-stone-300 text-stone-700 font-bold py-2 px-6 rounded-md shadow-md transition-transform transform hover:scale-105" data-i18n="apiKeyModal.cancel"></button>
                </div>
                 <p id="save-status" class="text-sm text-green-600 mt-2 h-4"></p>
            </div>
        </div>
    </div>
    
    <div id="ai-tutor-modal" class="modal-overlay">
        <div id="ai-tutor-modal-container" class="modal-container">
            <div id="ai-tutor-modal-header" class="w-full pb-4 border-b border-gray-200 cursor-move">
                 <h3 class="text-2xl font-bold text-purple-700" data-i18n="aiTutorModal.title"></h3>
            </div>
            <button id="ai-tutor-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <div id="ai-tutor-status" class="text-stone-700 leading-relaxed space-y-4 min-h-[50px] mt-4"></div>
            <audio id="ai-tutor-audio" class="w-full mt-4" controls></audio>
        </div>
    </div>

    <script>
    window.addEventListener('load', () => {
    
        // =================================================================
        // 1. 資料與狀態管理 (DATA & STATE MANAGEMENT)
        // =================================================================
        // 摘要: 此模組負責管理應用程式的狀態 (例如目前的語言) 
        // 以及儲存所有範例和 UI 文本的資料。
        
        const AppState = {
            currentLanguage: 'zh', // 'zh' 或 'en'
            activeExampleIndex: 0
        };

        const Translations = {
            zh: {
                header: {
                    title: "微積分(II)重補修班",
                    subtitle: "授課老師:吳文銓 (Prof. Wu Wen-Chuan)"
                },
                nav: { concepts: "核心概念", examples: "範例說明", practice: "自我練習" },
                main: { title: "10.2 參數曲線的微積分", subtitle: "Calculus with Parametric Curves" },
                concepts: {
                    title: "第一部分：核心概念",
                    summary: {
                        title: "🤔 課程摘要",
                        p1: "本章節我們將學習如何將微積分的概念（如導數、面積、弧長）應用於參數方程所定義的曲線。這使我們能夠分析參數曲線的幾何特性，例如斜率和凹向性，並計算其所圍成的面積或自身的長度。",
                        l1: "<b>切線 (Tangents)</b><br>對於參數曲線 $x=f(t), y=g(t)$，其切線斜率 $\\frac{dy}{dx}$ 可以透過連鎖律求得：$\\frac{dy}{dx} = \\frac{dy/dt}{dx/dt}$，前提是 $dx/dt \\neq 0$。水平切線發生在 $dy/dt=0$ 處，而垂直切線發生在 $dx/dt=0$ 處。",
                        l2: "<b>面積 (Area)</b><br>若一條參數曲線 $C$ 由 $x=f(t), y=g(t), \\alpha \\le t \\le \\beta$ 給出，且曲線只被描繪一次，則其下方與 x 軸所圍成的面積為 $A = \\int_a^b y \\, dx = \\int_\\alpha^\\beta g(t) f'(t) \\, dt$。",
                        l3: "<b>弧長 (Arc Length)</b><br>參數曲線 $C$ 從 $t=\\alpha$ 到 $t=\\beta$ 的弧長可以透過積分計算：$L = \\int_\\alpha^\\beta \\sqrt{(\\frac{dx}{dt})^2 + (\\frac{dy}{dt})^2} \\, dt$。"
                    },
                    objectives: {
                        title: "🎯 學習目的",
                        l1: "計算參數曲線在某一點的切線斜率。",
                        l2: "求出參數曲線的水平切線與垂直切線所在的位置。",
                        l3: "使用積分計算由參數曲線所圍成的區域面積。",
                        l4: "使用積分計算參數曲線的弧長。"
                    }
                },
                examples: {
                    title: "第二部分：範例說明",
                    subtitle: "請選擇題型範例。每個範例都將引導您完成從「觀察分析」到「解題」的完整流程。",
                    analysisTitle: "觀察與分析：",
                    stepsTitle: "解題步驟：",
                    aiTutorButton: "AI助教解說"
                },
                practice: {
                    title: "第三部分：自我練習 (課本)",
                    answerButton: "答案",
                    q1_instruction: "求 $\\frac{dx}{dt}, \\frac{dy}{dt}, \\text{ and } \\frac{dy}{dx}$",
                    q1_instruction_plain: "求參數曲線的導數 dx/dt, dy/dt, 和 dy/dx:",
                    q2_instruction: "求在指定參數值時的切線方程式",
                    q2_instruction_plain: "求參數曲線在指定參數值時的切線方程式:",
                    q3_instruction: "用兩種方法求在指定點的切線方程式",
                    q3_instruction_plain: "用兩種方法求參數曲線在指定點的切線方程式:",
                    copyButtonTitle: "複製題目",
                    copied: "已複製！",
                    problems1: [
                        "$x = 2t^3 + 3t, y = 4t - 5t^2$",
                        "$x = t - \\ln t, y = t^2 - t^{-2}$",
                        "$x = te^t, y = t + \\sin t$",
                        "$x = t + \\sin(t^2+2), y = \\tan(t^2+2)$"
                    ],
                    problems2: [
                        "$x = t^3 + 1, y = t^4 + t; \\quad t = -1$",
                        "$x = \\sqrt{t}, y = t^2 - 2t; \\quad t = 4$",
                        "$x = \\sin 2t + \\cos t, y = \\cos 2t - \\sin t; \\quad t = \\pi$",
                        "$x = e^t \\sin \\pi t, y = e^{2t}; \\quad t=0$"
                    ],
                    problems3: [
                        "$x = \\sin t, y = \\cos^2 t; \\quad (\\frac{1}{2}, \\frac{3}{4})$",
                        "$x = \\sqrt{t+4}, y = 1/(t+4); \\quad (2, \\frac{1}{4})$"
                    ]
                },
                footer: { text: "微積分互動教學" },
                apiKeyModal: {
                    title: "設定 Google AI Studio API Key",
                    p1: "請輸入您的 API Key 以啟用 AI 助教功能。您的 Key 將只會儲存在您的瀏覽器中。",
                    save: "儲存",
                    cancel: "取消"
                },
                aiTutorModal: { title: "AI 助教語音解說" }
            },
            en: {
                header: {
                    title: "Calculus (II)",
                    subtitle: "Instructor: Prof. Wu Wen-Chuan"
                },
                nav: { concepts: "Core Concepts", examples: "Examples", practice: "Practice" },
                main: { title: "10.2 Calculus with Parametric Curves", subtitle: "參數曲線的微積分" },
                concepts: {
                    title: "Part 1: Core Concepts",
                    summary: {
                        title: "🤔 Lesson Summary",
                        p1: "In this section, we will learn how to apply calculus concepts (like derivatives, area, and arc length) to curves defined by parametric equations. This allows us to analyze the geometric properties of parametric curves, such as slope and concavity, and to calculate the area they enclose or their own length.",
                        l1: "<b>Tangents</b><br>For a parametric curve $x=f(t), y=g(t)$, the slope of the tangent line $dy/dx$ can be found using the Chain Rule: $\\frac{dy}{dx} = \\frac{dy/dt}{dx/dt}$, provided that $dx/dt \\neq 0$. Horizontal tangents occur where $dy/dt=0$, and vertical tangents occur where $dx/dt=0$.",
                        l2: "<b>Area</b><br>If a curve $C$ is given by $x=f(t), y=g(t), \\alpha \\le t \\le \\beta$, and is traced only once, the area under it from x=a to x=b is $A = \\int_a^b y \\, dx = \\int_\\alpha^\\beta g(t) f'(t) \\, dt$.",
                        l3: "<b>Arc Length</b><br>The arc length of a parametric curve $C$ from $t=\\alpha$ to $t=\\beta$ can be calculated by an integral: $L = \\int_\\alpha^\\beta \\sqrt{(\\frac{dx}{dt})^2 + (\\frac{dy}{dt})^2} \\, dt$."
                    },
                    objectives: {
                        title: "🎯 Learning Objectives",
                        l1: "Calculate the slope of the tangent line to a parametric curve at a given point.",
                        l2: "Find the points where a parametric curve has horizontal and vertical tangents.",
                        l3: "Use integration to find the area of a region enclosed by a parametric curve.",
                        l4: "Use integration to find the arc length of a parametric curve."
                    }
                },
                examples: {
                    title: "Part 2: Examples",
                    subtitle: "Select an example. Each one will guide you through the complete process from 'Analysis' to 'Solution'.",
                    analysisTitle: "Observation & Analysis:",
                    stepsTitle: "Solution Steps:",
                    aiTutorButton: "AI Tutor Explanation"
                },
                practice: {
                    title: "Part 3: Self Practice (Textbook)",
                    answerButton: "Solution",
                    q1_instruction: "Find $\\frac{dx}{dt}, \\frac{dy}{dt}, \\text{ and } \\frac{dy}{dx}$",
                    q1_instruction_plain: "Find dx/dt, dy/dt, and dy/dx for the parametric curve:",
                    q2_instruction: "Find an equation of the tangent to the curve at the point corresponding to the given value of the parameter.",
                    q2_instruction_plain: "Find an equation of the tangent to the curve at the point corresponding to the given value of the parameter:",
                    q3_instruction: "Find an equation of the tangent to the curve at the given point by two methods.",
                    q3_instruction_plain: "Find an equation of the tangent to the curve at the given point by two methods:",
                    copyButtonTitle: "Copy problem",
                    copied: "Copied!",
                     problems1: [
                        "$x = 2t^3 + 3t, y = 4t - 5t^2$",
                        "$x = t - \\ln t, y = t^2 - t^{-2}$",
                        "$x = te^t, y = t + \\sin t$",
                        "$x = t + \\sin(t^2+2), y = \\tan(t^2+2)$"
                    ],
                    problems2: [
                        "$x = t^3 + 1, y = t^4 + t; \\quad t = -1$",
                        "$x = \\sqrt{t}, y = t^2 - 2t; \\quad t = 4$",
                        "$x = \\sin 2t + \\cos t, y = \\cos 2t - \\sin t; \\quad t = \\pi$",
                        "$x = e^t \\sin \\pi t, y = e^{2t}; \\quad t=0$"
                    ],
                    problems3: [
                        "$x = \\sin t, y = \\cos^2 t; \\quad (\\frac{1}{2}, \\frac{3}{4})$",
                        "$x = \\sqrt{t+4}, y = 1/(t+4); \\quad (2, \\frac{1}{4})$"
                    ]
                },
                footer: { text: "Interactive Calculus Tutorial" },
                apiKeyModal: {
                    title: "Set Google AI Studio API Key",
                    p1: "Please enter your API Key to enable the AI Tutor feature. Your key will be stored only in your browser.",
                    save: "Save",
                    cancel: "Cancel"
                },
                aiTutorModal: { title: "AI Tutor Voice Explanation" }
            }
        };
        
        const ExamplesData = [
            {
                title: { zh: '尋找切線與凹性', en: 'Finding Tangents and Concavity'},
                problem: { zh: '一曲線 C 由參數方程 $x = t^2, y = t^3 - 3t$ 定義。 (a) 證明 C 在點 (3, 0) 有兩條切線並求其方程式。 (b) 找出 C 上切線為水平或垂直的點。(c) 判斷曲線在何處為凹向上或凹向下。(d) 描繪曲線。', en: 'A curve C is defined by the parametric equations $x = t^2, y = t^3 - 3t$. (a) Show that C has two tangents at the point (3, 0) and find their equations. (b) Find the points on C where the tangent is horizontal or vertical. (c) Determine where the curve is concave upward or downward. (d) Sketch the curve.'},
                source: 'p.674 Example 1',
                analysis: {
                    zh: '首先，我們需要計算導數 $\\frac{dy}{dx}$ 以求得斜率。對於凹性，我們需要計算二階導數 $\\frac{d^2y}{dx^2}$。水平切線發生在 $\\frac{dy}{dt}=0$ 時，垂直切線發生在 $\\frac{dx}{dt}=0$ 時。最後，綜合所有資訊來描繪曲線。',
                    en: 'First, we need to calculate the derivative $\\frac{dy}{dx}$ to find the slope. For concavity, we need the second derivative, $\\frac{d^2y}{dx^2}$. Horizontal tangents occur when $\\frac{dy}{dt}=0$ and vertical tangents occur when $\\frac{dx}{dt}=0$. Finally, we combine all this information to sketch the curve.'
                },
                steps: [
                    {
                        title: { zh: '步驟 1：計算一階導數', en: 'Step 1: Find the First Derivative'},
                        content: { zh: `我們有 $\\frac{dx}{dt} = 2t$ 和 $\\frac{dy}{dt} = 3t^2 - 3$。因此，切線斜率為： $$\\frac{dy}{dx} = \\frac{dy/dt}{dx/dt} = \\frac{3t^2 - 3}{2t}$$`, en: `We have $\\frac{dx}{dt} = 2t$ and $\\frac{dy}{dt} = 3t^2 - 3$. Therefore, the slope of the tangent is: $$\\frac{dy}{dx} = \\frac{dy/dt}{dx/dt} = \\frac{3t^2 - 3}{2t}$$` }
                    },
                    {
                        title: { zh: '步驟 2：處理點 (3, 0) 的切線', en: 'Step 2: Find Tangents at point (3, 0)' },
                        content: { zh: `當點為 $(3, 0)$ 時，$x=t^2=3$ 給出 $t = \\pm\\sqrt{3}$。這兩個 $t$ 值都滿足 $y=0$。因此，曲線在 $(3,0)$ 處自交。<br>當 $t=\\sqrt{3}$，斜率為 $\\frac{dy}{dx} = \\sqrt{3}$。切線方程式為 $y = \\sqrt{3}(x-3)$。 <br>當 $t=-\\sqrt{3}$，斜率為 $\\frac{dy}{dx} = -\\sqrt{3}$。切線方程式為 $y = -\\sqrt{3}(x-3)$。`, en: `When the point is $(3, 0)$, $x=t^2=3$ gives $t = \\pm\\sqrt{3}$. Both $t$ values satisfy $y=0$. Thus, the curve crosses itself at $(3,0)$.<br>For $t=\\sqrt{3}$, the slope is $\\frac{dy}{dx} = \\sqrt{3}$. The tangent line is $y = \\sqrt{3}(x-3)$. <br>For $t=-\\sqrt{3}$, the slope is $\\frac{dy}{dx} = -\\sqrt{3}$. The tangent line is $y = -\\sqrt{3}(x-3)$.` }
                    },
                    {
                        title: { zh: '步驟 3：尋找水平與垂直切線', en: 'Step 3: Find Horizontal and Vertical Tangents' },
                        content: { 
                            zh: `<b>水平切線:</b> $\\frac{dy}{dt} = 3t^2 - 3 = 0 \\implies t = \\pm 1$。對應的點是 $(1, -2)$ 和 $(1, 2)$。<br><b>垂直切線:</b> $\\frac{dx}{dt} = 2t = 0 \\implies t = 0$。對應的點是 $(0, 0)$。`,
                            en: `<b>Horizontal Tangents:</b> $\\frac{dy}{dt} = 3t^2 - 3 = 0 \\implies t = \\pm 1$. The corresponding points are $(1, -2)$ and $(1, 2)$.<br><b>Vertical Tangents:</b> $\\frac{dx}{dt} = 2t = 0 \\implies t = 0$. The corresponding point is $(0, 0)$.`
                        }
                    },
                    {
                        title: { zh: '步驟 4：判斷凹性並描繪曲線', en: 'Step 4: Determine Concavity and Sketch' },
                        content: { 
                            zh: `為了找出凹性，我們計算二階導數： $$\\frac{d^2y}{dx^2} = \\frac{\\frac{d}{dt}(\\frac{dy}{dx})}{\\frac{dx}{dt}} = \\frac{\\frac{3(t^2+1)}{2t^2}}{2t} = \\frac{3(t^2+1)}{4t^3}$$ 當 $t>0$ 時，曲線凹向上。當 $t<0$ 時，曲線凹向下。
                            <img src="10.2_1.png" alt="圖1" class="mx-auto max-w-sm">`,
                            en: `To find concavity, we compute the second derivative: $$\\frac{d^2y}{dx^2} = \\frac{\\frac{d}{dt}(\\frac{dy}{dx})}{\\frac{dx}{dt}} = \\frac{\\frac{3(t^2+1)}{2t^2}}{2t} = \\frac{3(t^2+1)}{4t^3}$$ The curve is concave upward when $t>0$ and concave downward when $t<0$.
                            <img src="10.2_1.png" alt="圖1" class="mx-auto max-w-sm">`
                        }
                    }
                ]
            },
            {
                title: { zh: '擺線下的面積', en: 'Area under a Cycloid'},
                problem: { zh: '求擺線 $x = r(\\theta - \\sin\\theta), y = r(1 - \\cos\\theta)$ 一拱下方的面積。', en: 'Find the area under one arch of the cycloid $x = r(\\theta - \\sin\\theta), y = r(1 - \\cos\\theta)$.'},
                source: 'p.675 Example 3',
                analysis: {
                    zh: '擺線的一拱是由參數 $\\theta$ 從 $0$ 走到 $2\\pi$ 描繪出來的。我們可以使用面積公式 $A = \\int y \\, dx$。我們需要將所有變數都用參數 $\\theta$ 來表示，包括 $dx$ 和積分的上下限。',
                    en: 'One arch of the cycloid is traced as the parameter $\\theta$ goes from $0$ to $2\\pi$. We can use the area formula $A = \\int y \\, dx$. We need to express everything, including $dx$ and the limits of integration, in terms of the parameter $\\theta$.'
                },
                steps: [
                    {
                        title: { zh: '步驟 1：設定積分', en: 'Step 1: Set up the Integral' },
                        content: { zh: `我們有 $y = r(1 - \\cos\\theta)$ 且 $dx = \\frac{dx}{d\\theta}d\\theta = r(1 - \\cos\\theta)d\\theta$。當 $\\theta$ 從 $0$ 增加到 $2\\pi$ 時，$x$ 從 $0$ 增加到 $2\\pi r$。因此，面積為： $$A = \\int_{x=0}^{x=2\\pi r} y \\, dx = \\int_{\\theta=0}^{\\theta=2\\pi} r(1 - \\cos\\theta) \\cdot r(1 - \\cos\\theta) \\, d\\theta$$`, en: `We have $y = r(1 - \\cos\\theta)$ and $dx = \\frac{dx}{d\\theta}d\\theta = r(1 - \\cos\\theta)d\\theta$. As $\\theta$ increases from $0$ to $2\\pi$, $x$ increases from $0$ to $2\\pi r$. So the area is: $$A = \\int_{x=0}^{x=2\\pi r} y \\, dx = \\int_{\\theta=0}^{\\theta=2\\pi} r(1 - \\cos\\theta) \\cdot r(1 - \\cos\\theta) \\, d\\theta$$` }
                    },
                    {
                        title: { zh: '步驟 2：計算積分', en: 'Step 2: Evaluate the Integral' },
                        content: { 
                            zh: `$$A = r^2 \\int_0^{2\\pi} (1 - 2\\cos\\theta + \\cos^2\\theta) \\, d\\theta$$ 使用半角公式 $\\cos^2\\theta = \\frac{1}{2}(1+\\cos(2\\theta))$: $$A = r^2 \\int_0^{2\\pi} \\left(1 - 2\\cos\\theta + \\frac{1}{2}(1+\\cos(2\\theta))\\right) \\, d\\theta$$ $$A = r^2 \\left[\\frac{3}{2}\\theta - 2\\sin\\theta + \\frac{1}{4}\\sin(2\\theta)\\right]_0^{2\\pi} = r^2 \\left( \\frac{3}{2}(2\\pi) \\right) = 3\\pi r^2$$
                            <img src="10.2_2.png" alt="圖2" class="mx-auto max-w-sm">`,
                            en: `$$A = r^2 \\int_0^{2\\pi} (1 - 2\\cos\\theta + \\cos^2\\theta) \\, d\\theta$$ Using the half-angle identity $\\cos^2\\theta = \\frac{1}{2}(1+\\cos(2\\theta))$: $$A = r^2 \\int_0^{2\\pi} \\left(1 - 2\\cos\\theta + \\frac{1}{2}(1+\\cos(2\\theta))\\right) \\, d\\theta$$ $$A = r^2 \\left[\\frac{3}{2}\\theta - 2\\sin\\theta + \\frac{1}{4}\\sin(2\\theta)\\right]_0^{2\\pi} = r^2 \\left( \\frac{3}{2}(2\\pi) \\right) = 3\\pi r^2$$
                            <img src="10.2_2.png" alt="圖2" class="mx-auto max-w-sm">`
                        }
                    }
                ]
            },
            {
                title: { zh: '擺線的弧長', en: 'Arc Length of a Cycloid' },
                problem: { zh: '求擺線 $x = r(\\theta - \\sin\\theta), y = r(1 - \\cos\\theta)$ 一拱的弧長。', en: 'Find the length of one arch of the cycloid $x = r(\\theta - \\sin\\theta), y = r(1 - \\cos\\theta)$.' },
                source: 'p.678 Example 5',
                analysis: {
                    zh: '擺線的一拱對應於參數區間 $0 \\le \\theta \\le 2\\pi$。我們需要計算 $\\frac{dx}{d\\theta}$ 和 $\\frac{dy}{d\\theta}$，然後代入弧長公式 $L = \\int_0^{2\\pi} \\sqrt{(\\frac{dx}{d\\theta})^2 + (\\frac{dy}{d\\theta})^2} \\, d\\theta$。',
                    en: 'One arch of the cycloid corresponds to the parameter interval $0 \\le \\theta \\le 2\\pi$. We need to find $\\frac{dx}{d\\theta}$ and $\\frac{dy}{d\\theta}$ and plug them into the arc length formula $L = \\int_0^{2\\pi} \\sqrt{(\\frac{dx}{d\\theta})^2 + (\\frac{dy}{d\\theta})^2} \\, d\\theta$.'
                },
                steps: [
                     {
                        title: { zh: '步驟 1：計算導數平方和', en: 'Step 1: Find the Sum of Squared Derivatives' },
                        content: { zh: `$\\frac{dx}{d\\theta} = r(1 - \\cos\\theta)$ 和 $\\frac{dy}{d\\theta} = r\\sin\\theta$。 <br> $$(\\frac{dx}{d\\theta})^2 + (\\frac{dy}{d\\theta})^2 = r^2(1 - 2\\cos\\theta + \\cos^2\\theta) + r^2\\sin^2\\theta$$ $$= r^2(1 - 2\\cos\\theta + 1) = 2r^2(1 - \\cos\\theta)$$`, 
                                 en: `$\\frac{dx}{d\\theta} = r(1 - \\cos\\theta)$ and $\\frac{dy}{d\\theta} = r\\sin\\theta$. <br> $$(\\frac{dx}{d\\theta})^2 + (\\frac{dy}{d\\theta})^2 = r^2(1 - 2\\cos\\theta + \\cos^2\\theta) + r^2\\sin^2\\theta$$ $$= r^2(1 - 2\\cos\\theta + 1) = 2r^2(1 - \\cos\\theta)$$` }
                    },
                    {
                        title: { zh: '步驟 2：計算弧長積分', en: 'Step 2: Evaluate the Arc Length Integral' },
                        content: { zh: `使用半角公式 $1 - \\cos\\theta = 2\\sin^2(\\theta/2)$，我們得到 $(\\frac{dx}{d\\theta})^2 + (\\frac{dy}{d\\theta})^2 = 4r^2\\sin^2(\\theta/2)$。因此， $$L = \\int_0^{2\\pi} \\sqrt{4r^2\\sin^2(\\theta/2)} \\, d\\theta = \\int_0^{2\\pi} 2r|\\sin(\\theta/2)| \\, d\\theta$$ 在 $0 \\le \\theta \\le 2\\pi$ 區間，$\\sin(\\theta/2) \\ge 0$，所以絕對值可以去掉。 $$L = 2r \\int_0^{2\\pi} \\sin(\\theta/2) \\, d\\theta = 2r[-2\\cos(\\theta/2)]_0^{2\\pi}$$ $$L = -4r(\\cos\\pi - \\cos 0) = -4r(-1 - 1) = 8r$$
                                        <img src="10.2_3.png" alt="圖3" class="mx-auto max-w-sm">`, 
                                 en: `Using the half-angle identity $1 - \\cos\\theta = 2\\sin^2(\\theta/2)$, we get $(\\frac{dx}{d\\theta})^2 + (\\frac{dy}{d\\theta})^2 = 4r^2\\sin^2(\\theta/2)$. Therefore, $$L = \\int_0^{2\\pi} \\sqrt{4r^2\\sin^2(\\theta/2)} \\, d\\theta = \\int_0^{2\\pi} 2r|\\sin(\\theta/2)| \\, d\\theta$$ On the interval $0 \\le \\theta \\le 2\\pi$, $\\sin(\\theta/2) \\ge 0$, so we can remove the absolute value. $$L = 2r \\int_0^{2\\pi} \\sin(\\theta/2) \\, d\\theta = 2r[-2\\cos(\\theta/2)]_0^{2\\pi}$$ $$L = -4r(\\cos\\pi - \\cos 0) = -4r(-1 - 1) = 8r$$
                                        <img src="10.2_3.png" alt="圖3" class="mx-auto max-w-sm">` }
                    }
                ]
            },
            {
                title: { zh: '旋轉體的表面積', en: 'Surface Area of Revolution' },
                problem: { zh: '證明半徑為 r 的球體表面積為 $4\\pi r^2$。', en: 'Show that the surface area of a sphere of radius r is $4\\pi r^2$.' },
                source: 'p.678 Example 7',
                analysis: {
                    zh: '我們可以透過將一個半圓繞其直徑旋轉來得到一個球體。半圓可以由參數方程 $x = r\\cos t, y = r\\sin t$ for $0 \\le t \\le \\pi$ 表示。然後我們使用參數曲線的旋轉體表面積公式。',
                    en: 'We can obtain a sphere by rotating a semicircle about its diameter. A semicircle can be represented by the parametric equations $x = r\\cos t, y = r\\sin t$ for $0 \\le t \\le \\pi$. We then use the formula for the surface area of revolution for parametric curves.'
                },
                steps: [
                     {
                        title: { zh: '步驟 1：設定積分', en: 'Step 1: Set up the Integral' },
                        content: { zh: `我們有 $\\frac{dx}{dt} = -r\\sin t$ 和 $\\frac{dy}{dt} = r\\cos t$。 <br> $(\\frac{dx}{dt})^2 + (\\frac{dy}{dt})^2 = r^2\\sin^2 t + r^2\\cos^2 t = r^2$。 <br>表面積公式為 $S = \\int_0^\\pi 2\\pi y \\sqrt{(\\frac{dx}{dt})^2 + (\\frac{dy}{dt})^2} \\, dt$。 <br> $$S = \\int_0^\\pi 2\\pi(r\\sin t) \\sqrt{r^2} \\, dt = 2\\pi r^2 \\int_0^\\pi \\sin t \\, dt$$`, 
                                 en: `We have $\\frac{dx}{dt} = -r\\sin t$ and $\\frac{dy}{dt} = r\\cos t$. <br> $(\\frac{dx}{dt})^2 + (\\frac{dy}{dt})^2 = r^2\\sin^2 t + r^2\\cos^2 t = r^2$. <br>The surface area formula is $S = \\int_0^\\pi 2\\pi y \\sqrt{(\\frac{dx}{dt})^2 + (\\frac{dy}{dt})^2} \\, dt$. <br> $$S = \\int_0^\\pi 2\\pi(r\\sin t) \\sqrt{r^2} \\, dt = 2\\pi r^2 \\int_0^\\pi \\sin t \\, dt$$` }
                    },
                    {
                        title: { zh: '步驟 2：計算積分', en: 'Step 2: Evaluate the Integral' },
                        content: { zh: `$$S = 2\\pi r^2 [-\\cos t]_0^\\pi = 2\\pi r^2 ( -\\cos\\pi - (-\\cos 0) ) $$ $$ S = 2\\pi r^2 ( -(-1) - (-1) ) = 2\\pi r^2(2) = 4\\pi r^2$$`, 
                                 en: `$$S = 2\\pi r^2 [-\\cos t]_0^\\pi = 2\\pi r^2 ( -\\cos\\pi - (-\\cos 0) ) $$ $$ S = 2\\pi r^2 ( -(-1) - (-1) ) = 2\\pi r^2(2) = 4\\pi r^2$$` }
                    }
                ]
            }
        ];
        
        // =================================================================
        // 2. UI 渲染模組 (UI RENDERING MODULE)
        // =================================================================
        // 摘要: 此模組負責所有 DOM 操作，包括根據目前的語言渲染頁籤、
        // 範例內容以及更新靜態文本。
        
        const UIRenderer = {
            async init() {
                this.updateAllText(AppState.currentLanguage);
                this.renderTabs(AppState.currentLanguage);
                this.renderExampleContent(AppState.activeExampleIndex, AppState.currentLanguage);
                this.renderPracticeProblems(AppState.currentLanguage);
                await MathJax.typesetPromise();
            },
            
            updateAllText(lang) {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    const translation = key.split('.').reduce((obj, k) => obj && obj[k], Translations[lang]);
                    if (translation) {
                        el.textContent = translation;
                    }
                });
                
                 document.querySelectorAll('[data-i18n-html]').forEach(el => {
                    const key = el.dataset.i18nHtml;
                    const translation = key.split('.').reduce((obj, k) => obj && obj[k], Translations[lang]);
                    if (translation) {
                        el.innerHTML = translation;
                    }
                });
                
                // 更新特定元素，如 placeholder
                const apiKeyInput = document.getElementById('api-key-input');
                apiKeyInput.placeholder = lang === 'zh' ? '請在此輸入 API Key' : 'Enter API Key here';
            },

            renderTabs(lang) {
                const container = document.getElementById('example-tabs-container');
                container.innerHTML = ExamplesData.map((ex, i) => {
                    const title = ex.title[lang] || ex.title['en'];
                    return `<button data-index="${i}" class="tab-button text-base sm:text-lg py-3 px-5 rounded-lg transition duration-300 ${i === AppState.activeExampleIndex ? 'active-tab' : 'inactive-tab'}">${title}</button>`;
                }).join('');

                container.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const newIndex = parseInt(e.currentTarget.dataset.index);
                        AppState.activeExampleIndex = newIndex;
                        this.renderTabs(lang);
                        this.renderExampleContent(newIndex, lang);
                    });
                });
            },

            async renderExampleContent(index, lang) {
                const container = document.getElementById('example-content-container');
                const example = ExamplesData[index];
                const t = Translations[lang].examples;

                const stepsHtml = example.steps.map((step, i) => `
                    <div class="border-b border-stone-200 last:border-b-0">
                        <button class="accordion-header w-full text-left p-5 focus:outline-none hover:bg-purple-50 transition duration-300 flex justify-between items-center">
                            <span class="font-semibold text-lg text-stone-700">${step.title[lang]}</span>
                            <svg class="w-6 h-6 text-purple-600 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-5 bg-stone-50 border-t border-stone-200 text-stone-600 leading-relaxed math-display">${step.content[lang]}</div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="mb-8">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                             <h4 class="text-2xl font-bold text-stone-800">${example.title[lang]}</h4>
                             <button id="ai-tutor-button" data-index="${index}" class="ai-tutor-btn flex items-center justify-center gap-2 bg-purple-500 text-white font-bold py-3 px-5 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:opacity-70 disabled:cursor-not-allowed">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
                                 <span>${t.aiTutorButton}</span>
                             </button>
                        </div>
                        <div class="p-5 bg-amber-100/70 rounded-lg text-xl math-display">${example.problem[lang]}</div>
                        ${example.source ? `<p class="mt-2 text-base text-stone-500 text-right font-en">${example.source}</p>` : ''}
                    </div>
                    <div class="mb-8">
                        <h4 class="text-2xl font-bold text-stone-800 mb-3">${t.analysisTitle}</h4>
                        <p class="p-5 bg-sky-100/70 rounded-lg text-stone-600">${example.analysis[lang]}</p>
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold text-stone-800 mb-3">${t.stepsTitle}</h4>
                        <div class="border border-stone-200 rounded-lg overflow-hidden">${stepsHtml}</div>
                    </div>
                `;
                
                this.attachEventListeners();
                // 觸發 MathJax 重新渲染新的內容
                await MathJax.typesetPromise();
            },
            
            renderPracticeProblems(lang) {
                const t = Translations[lang].practice;
                if (!document.getElementById('practice')) return; 

                const list1Info = { el: document.getElementById('practice-list-1'), problems: t.problems1, instruction: t.q1_instruction_plain };
                const list2Info = { el: document.getElementById('practice-list-2'), problems: t.problems2, instruction: t.q2_instruction_plain };
                const list3Info = { el: document.getElementById('practice-list-3'), problems: t.problems3, instruction: t.q3_instruction_plain };
                
                const copyIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

                [list1Info, list2Info, list3Info].forEach(listInfo => {
                    if (listInfo.el) {
                        // Clear existing list items before re-rendering
                        listInfo.el.innerHTML = ''; 
                        listInfo.problems.forEach((problem, index) => {
                            const cleanProblem = problem.replace(/\$/g, '').replace(/<[^>]*>/g, '').replace(/\\quad/g, ' ').replace(/\\/g, '');
                            const copyText = `${listInfo.instruction} ${cleanProblem}`;
                            
                            const li = document.createElement('li');
                            li.className = 'flex justify-between items-center group py-1';
                            
                            // Get the original number if the list has a 'start' attribute
                            const itemNumber = (listInfo.el.start || 1) + index;
                            
                            li.innerHTML = `
                                <span class="flex items-center">
                                    <span class="mr-2 font-bold">${itemNumber}.</span>
                                    <span>${problem.replace(/<[^>]*>/g, '')}</span>
                                </span>
                                <span class="copy-container relative">
                                    <button data-copy-text="${copyText}" class="copy-btn p-1 rounded-md hover:bg-purple-100" title="${t.copyButtonTitle}">
                                        ${copyIconSvg}
                                    </button>
                                </span>`;
                            listInfo.el.appendChild(li);
                        });
                    }
                });
            },

            attachEventListeners() {
                // 手風琴 (Accordion) 邏輯
                document.querySelectorAll('#example-content-container .accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.nextElementSibling.classList.toggle('show');
                        header.querySelector('svg').classList.toggle('rotate-180');
                    });
                });
                
                // AI 助教按鈕邏輯
                const aiTutorButton = document.getElementById('ai-tutor-button');
                const apiKey = localStorage.getItem('googleApiKey');
                if (!apiKey) {
                    aiTutorButton.disabled = true;
                    aiTutorButton.title = AppState.currentLanguage === 'zh' ? '請先設定 API Key' : 'Please set API Key first';
                }
                aiTutorButton.addEventListener('click', (e) => {
                    AITutor.handleRequest(e.currentTarget.dataset.index, AppState.currentLanguage);
                });
            }
        };

        // =================================================================
        // 3. 彈出視窗管理模組 (MODAL MANAGEMENT MODULE)
        // =================================================================
        // 摘要: 處理所有與彈出視窗相關的功能，包括開啟、關閉，
        // 以及讓視窗可拖動。
        
        const ModalManager = {
            init() {
                this.apiKeyModal = document.getElementById('api-key-modal');
                this.aiTutorModal = document.getElementById('ai-tutor-modal');
                
                this.setupModal(this.apiKeyModal, 'api-key-modal-trigger', 'api-key-modal-close');
                this.setupModal(this.aiTutorModal, null, 'ai-tutor-modal-close');
                
                document.getElementById('api-key-modal-cancel').addEventListener('click', () => this.apiKeyModal.classList.remove('show'));
                document.getElementById('api-key-save').addEventListener('click', this.saveApiKey.bind(this));

                this.makeDraggable(document.getElementById('ai-tutor-modal-container'), document.getElementById('ai-tutor-modal-header'));
            },

            setupModal(modal, triggerId, closeButtonId) {
                const trigger = document.getElementById(triggerId);
                const closeBtn = document.getElementById(closeButtonId);
                
                const openModal = () => modal.classList.add('show');
                const closeModal = () => {
                    modal.classList.remove('show');
                    if (modal.id === 'ai-tutor-modal') {
                        const audioPlayer = document.getElementById('ai-tutor-audio');
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                    }
                };

                if (trigger) trigger.addEventListener('click', openModal);
                if (closeBtn) closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            },
            
            saveApiKey() {
                const apiKeyInput = document.getElementById('api-key-input');
                const saveStatus = document.getElementById('save-status');
                const key = apiKeyInput.value.trim();
                
                if (key) {
                    localStorage.setItem('googleApiKey', key);
                    saveStatus.textContent = AppState.currentLanguage === 'zh' ? 'API Key 已儲存！' : 'API Key saved!';
                } else {
                    localStorage.removeItem('googleApiKey');
                    saveStatus.textContent = AppState.currentLanguage === 'zh' ? 'API Key 已清除。' : 'API Key cleared.';
                }
                
                UIRenderer.renderExampleContent(AppState.activeExampleIndex, AppState.currentLanguage);
                setTimeout(() => {
                    this.apiKeyModal.classList.remove('show');
                    saveStatus.textContent = '';
                }, 1000);
            },
            
            makeDraggable(modal, header) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                header.onmousedown = (e) => {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                    document.onmousemove = (ev) => {
                        ev.preventDefault();
                        pos1 = pos3 - ev.clientX;
                        pos2 = pos4 - ev.clientY;
                        pos3 = ev.clientX;
                        pos4 = ev.clientY;
                        modal.style.top = (modal.offsetTop - pos2) + "px";
                        modal.style.left = (modal.offsetLeft - pos1) + "px";
                        modal.style.transform = 'none'; 
                    };
                };
            }
        };

        // =================================================================
        // 4. AI 助教模組 (AI TUTOR MODULE)
        // =================================================================
        // 摘要: 此模組處理所有與 Google AI API 的互動，包括生成
        // 文字解釋並將其轉換為語音。
        
        const AITutor = {
            async handleRequest(index, lang) {
                const apiKey = localStorage.getItem('googleApiKey');
                if (!apiKey) return;
                
                const example = ExamplesData[index];
                const stepsText = example.steps.map(s => `${s.title[lang]}:\n${s.content[lang].replace(/<br>/g, '\n').replace(/<[^>]*>/g, '')}`).join('\n\n');
                const prompt = `Problem:\n${example.problem[lang].replace(/<[^>]*>/g, '')}\n\nAnalysis:\n${example.analysis[lang]}\n\nSolution Steps:\n${stepsText}`;
                
                const systemPrompt = lang === 'zh'
                    ? "你是一位親切的微積分助教。請用簡單易懂、口語化的方式，解說以下的微積分題目。請先解釋解題的思路，然後逐步說明解題過程。"
                    : "You are a friendly calculus tutor. Explain the following calculus problem in a simple, conversational way. First, explain the overall thinking process, then walk through the solution steps.";

                this.generateExplanation(prompt, systemPrompt, apiKey);
            },
            
            async _fetchWithRetry(url, options, maxRetries = 4) {
                let lastError;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) {
                            return response;
                        }
                        // Only retry on server errors or rate limiting
                        if (response.status === 429 || response.status >= 500) {
                            lastError = new Error(`API request failed with status ${response.status}`);
                        } else {
                            // Don't retry on other client errors (e.g., 400 Bad Request)
                            const errorBody = await response.text();
                            throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                        }
                    } catch (error) {
                        lastError = error;
                    }
                    // Wait with exponential backoff and jitter
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                throw lastError;
            },

            async generateExplanation(prompt, systemPrompt, apiKey) {
                const statusEl = document.getElementById('ai-tutor-status');
                const audioEl = document.getElementById('ai-tutor-audio');
                const modal = document.getElementById('ai-tutor-modal');
                
                // 重設並顯示彈出視窗
                const modalContainer = document.getElementById('ai-tutor-modal-container');
                modalContainer.style.top = '50%';
                modalContainer.style.left = '50%';
                modalContainer.style.transform = 'translate(-50%, -50%)';
                statusEl.innerHTML = `<p>${AppState.currentLanguage === 'zh' ? 'AI 助教思考中...' : 'AI Tutor is thinking...'}<span class="blinking-cursor"></span></p>`;
                audioEl.src = '';
                audioEl.hidden = true;
                modal.classList.add('show');
                
                const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                try {
                    const textPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const textResponse = await this._fetchWithRetry(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(textPayload) });
                    const textResult = await textResponse.json();
                    const explanationText = textResult.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!explanationText) throw new Error('Could not get valid text content from API.');
                    
                    statusEl.innerHTML = `<p>${AppState.currentLanguage === 'zh' ? '正在為您產生語音...' : 'Generating audio for you...'}<span class="blinking-cursor"></span></p>`;
                    
                    const ttsPayload = {
                        contents: [{ parts: [{ text: explanationText }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Sadaltager" } } }
                        }
                    };
                    const audioResponse = await this._fetchWithRetry(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ttsPayload) });
                    const audioResult = await audioResponse.json();
                    const audioData = audioResult?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    const mimeType = audioResult?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = this._base64ToArrayBuffer(audioData);
                        const wavBlob = this._pcmToWav(new Int16Array(pcmData), sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        statusEl.innerHTML = `<p>${AppState.currentLanguage === 'zh' ? '語音解說已就緒！' : 'Voice explanation is ready!'}</p>`;
                        audioEl.src = audioUrl;
                        audioEl.hidden = false;
                        audioEl.play();
                    } else {
                        throw new Error('Could not get valid audio content from API.');
                    }
                } catch (error) {
                    console.error("AI Tutor Error:", error);
                    statusEl.innerHTML = `<p class="text-red-600">${AppState.currentLanguage === 'zh' ? '抱歉，AI 助教出了一點問題：' : 'Sorry, the AI tutor ran into an issue:'}<br>${error.message}</p><p class="text-sm mt-2">${AppState.currentLanguage === 'zh' ? '請確認您的 API Key 是否正確且有足夠的權限。' : 'Please check if your API Key is correct and has sufficient permissions.'}</p>`;
                }
            },
            
            _base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            },

            _pcmToWav(pcmData, sampleRate) {
                const dataSize = pcmData.length * 2;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                view.setUint32(0, 0x52494646, false); // "RIFF"
                view.setUint32(4, 36 + dataSize, true);
                view.setUint32(8, 0x57415645, false); // "WAVE"
                view.setUint32(12, 0x666d7420, false); // "fmt "
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true); // numChannels
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true); // byteRate
                view.setUint16(32, 2, true); // blockAlign
                view.setUint16(34, 16, true); // bitsPerSample
                view.setUint32(36, 0x64617461, false); // "data"
                view.setUint32(40, dataSize, true);
                let offset = 44;
                for (let i = 0; i < pcmData.length; i++, offset += 2) {
                    view.setInt16(offset, pcmData[i], true);
                }
                return new Blob([view], { type: 'audio/wav' });
            }
        };

        // =================================================================
        // 5. 應用程式初始化 (APPLICATION INITIALIZATION)
        // =================================================================
        // 摘要: 這是應用程式的主要進入點。它會初始化所有模組並
        // 設定初始的事件監聽器。
        
        async function main() {
            const langToggleButton = document.getElementById('lang-toggle');
            
            langToggleButton.addEventListener('click', async () => {
                AppState.currentLanguage = AppState.currentLanguage === 'zh' ? 'en' : 'zh';
                langToggleButton.textContent = AppState.currentLanguage === 'zh' ? 'English' : '繁體中文';
                
                document.documentElement.lang = AppState.currentLanguage === 'zh' ? 'zh-Hant' : 'en';

                // 正確地管理 body 的 class 以切換字體樣式
                document.body.classList.remove('font-zh', 'font-en');
                if (AppState.currentLanguage === 'zh') {
                    document.body.classList.add('font-zh');
                } else {
                    document.body.classList.add('font-en');
                }

                await UIRenderer.init();
            });

            // 初始設定
            ModalManager.init();
            await UIRenderer.init();

            // 為練習區塊設定複製事件監聽器
            function copyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('無法複製題目:', err);
                }
                document.body.removeChild(textArea);
            }

            const practiceSection = document.getElementById('practice');
            if (practiceSection) {
                practiceSection.addEventListener('click', function(e) {
                    const copyBtn = e.target.closest('.copy-btn');
                    if (copyBtn) {
                        const textToCopy = copyBtn.dataset.copyText;
                        copyToClipboard(textToCopy);

                        // Visual feedback
                        const lang = AppState.currentLanguage;
                        const copiedText = Translations[lang].practice.copied;
                        const originalTitle = Translations[lang].practice.copyButtonTitle;
                        const checkIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                        const originalIcon = copyBtn.innerHTML;

                        copyBtn.innerHTML = checkIconSvg;
                        copyBtn.title = copiedText;
                        copyBtn.disabled = true;

                        setTimeout(() => {
                            copyBtn.innerHTML = originalIcon;
                            copyBtn.title = originalTitle;
                            copyBtn.disabled = false;
                        }, 1500);
                    }
                });
            }
        }

        main();
    });
    </script>
</body>
</html>


